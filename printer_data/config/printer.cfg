[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01204
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 5

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 120

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345]
;cs_pin: rpi:None

;[resonance_tester]
;accel_chip: adxl345
;probe_points:
;    112, 112, 20

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20

[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 51.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.238
#*# pid_ki = 0.838
#*# pid_kd = 1309.033
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.5051225983378953,
#*# 	1.8195102390006643,
#*# 	0.7021231371548109,
#*# 	0.5179341351214521,
#*# 	0.4514142856553639,
#*# 	-0.08515172425706082,
#*# 	-0.27110137461058453,
#*# 	0.12857188619028087,
#*# 	0.2608578490457167,
#*# 	0.06999231648430079
#*# model_domain = 3.1657411074412126e-07,3.292824091111193e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 23.534723
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.307412, 0.287205, 0.262688, 0.243968, 0.230825, 0.220678, 0.210344, 0.198209, 0.188460, 0.183121, 0.174413, 0.165797, 0.159482, 0.156792, 0.161382, 0.173048, 0.187145, 0.202562, 0.216882, 0.231895, 0.244781, 0.256465, 0.269335, 0.283356, 0.298898
#*# 	  0.277392, 0.255244, 0.231497, 0.215221, 0.198088, 0.186618, 0.177294, 0.166025, 0.156433, 0.149818, 0.141611, 0.133265, 0.125245, 0.122604, 0.126412, 0.135069, 0.146886, 0.161006, 0.174309, 0.185735, 0.196263, 0.205198, 0.214157, 0.226933, 0.241474
#*# 	  0.249810, 0.232432, 0.214505, 0.192315, 0.172181, 0.158526, 0.146888, 0.135777, 0.124906, 0.115465, 0.106993, 0.098152, 0.089804, 0.085947, 0.086635, 0.094344, 0.108448, 0.117443, 0.129705, 0.140978, 0.146437, 0.153943, 0.161920, 0.174488, 0.184563
#*# 	  0.221973, 0.210453, 0.192192, 0.168534, 0.145827, 0.132212, 0.120267, 0.110105, 0.100128, 0.090511, 0.080103, 0.071596, 0.064224, 0.057916, 0.058624, 0.067164, 0.080283, 0.092366, 0.102607, 0.111172, 0.116590, 0.123142, 0.131778, 0.144101, 0.151455
#*# 	  0.200567, 0.187011, 0.168344, 0.148838, 0.128998, 0.113500, 0.102512, 0.089602, 0.078094, 0.068473, 0.058940, 0.048668, 0.037782, 0.033266, 0.032593, 0.039847, 0.051633, 0.063878, 0.072983, 0.081043, 0.085977, 0.091854, 0.098976, 0.109586, 0.114952
#*# 	  0.176171, 0.159691, 0.140295, 0.124051, 0.106698, 0.093160, 0.079581, 0.065365, 0.053309, 0.041693, 0.029513, 0.018969, 0.009298, 0.003004, 0.002389, 0.006430, 0.017023, 0.027770, 0.036370, 0.044135, 0.049332, 0.055188, 0.061339, 0.068049, 0.070923
#*# 	  0.164686, 0.149323, 0.128960, 0.113984, 0.100386, 0.085728, 0.074667, 0.060266, 0.048433, 0.034070, 0.020302, 0.011305, 0.001307, -0.004467, -0.006460, 0.000313, 0.008505, 0.019705, 0.027613, 0.036584, 0.041119, 0.047085, 0.053922, 0.059613, 0.060623
#*# 	  0.157557, 0.139903, 0.121534, 0.107251, 0.089702, 0.076577, 0.066437, 0.052621, 0.038512, 0.025117, 0.011138, 0.000954, -0.007544, -0.014215, -0.014862, -0.010133, -0.002114, 0.007787, 0.015969, 0.023711, 0.029368, 0.033757, 0.040050, 0.044438, 0.044487
#*# 	  0.152963, 0.136282, 0.120089, 0.105904, 0.090803, 0.076485, 0.063038, 0.050179, 0.035992, 0.022321, 0.009485, -0.001837, -0.011721, -0.018163, -0.019424, -0.013658, -0.005164, 0.003327, 0.012787, 0.021491, 0.027736, 0.030825, 0.036979, 0.043313, 0.041515
#*# 	  0.146038, 0.129372, 0.112686, 0.100300, 0.083976, 0.068701, 0.053034, 0.038519, 0.026071, 0.011987, -0.000688, -0.013247, -0.024108, -0.031338, -0.033116, -0.029092, -0.020541, -0.012561, -0.003742, 0.005601, 0.009320, 0.014013, 0.021069, 0.024035, 0.022926
#*# 	  0.146455, 0.129590, 0.112691, 0.098861, 0.085049, 0.068769, 0.053623, 0.038898, 0.024900, 0.011507, -0.002203, -0.011139, -0.022081, -0.030944, -0.033856, -0.028621, -0.021212, -0.012106, -0.004526, 0.001401, 0.005866, 0.010944, 0.017013, 0.020826, 0.019719
#*# 	  0.152363, 0.136832, 0.115765, 0.101514, 0.086399, 0.070527, 0.055897, 0.043093, 0.028783, 0.012858, 0.000911, -0.006482, -0.017801, -0.028094, -0.033290, -0.028943, -0.021848, -0.013310, -0.006499, -0.001705, 0.002546, 0.008019, 0.014292, 0.018506, 0.016444
#*# 	  0.169691, 0.150512, 0.128079, 0.110405, 0.096237, 0.082234, 0.067073, 0.051257, 0.038419, 0.024275, 0.010664, 0.001997, -0.006760, -0.017326, -0.024884, -0.020977, -0.011690, -0.006903, 0.001247, 0.007520, 0.008801, 0.015641, 0.022028, 0.027432, 0.024555
#*# 	  0.180536, 0.160011, 0.136159, 0.117021, 0.102013, 0.088660, 0.074061, 0.059910, 0.048222, 0.033484, 0.019589, 0.009899, 0.000091, -0.008411, -0.011584, -0.010669, -0.001818, 0.005389, 0.018107, 0.022020, 0.025455, 0.028907, 0.038319, 0.040492, 0.038480
#*# 	  0.187793, 0.167006, 0.140098, 0.122163, 0.107386, 0.094141, 0.084242, 0.068889, 0.054806, 0.040975, 0.029460, 0.017222, 0.005980, -0.000134, -0.004226, 0.000365, 0.010412, 0.018760, 0.025969, 0.029998, 0.034316, 0.042135, 0.048294, 0.053603, 0.052192
#*# 	  0.182255, 0.163141, 0.142488, 0.127853, 0.113593, 0.102662, 0.090328, 0.077171, 0.064095, 0.050981, 0.039838, 0.029573, 0.018032, 0.012227, 0.009501, 0.015448, 0.025269, 0.034760, 0.042498, 0.047640, 0.052173, 0.059755, 0.067629, 0.074312, 0.075283
#*# 	  0.174279, 0.160907, 0.144699, 0.131295, 0.119114, 0.107650, 0.097254, 0.085140, 0.073232, 0.060574, 0.048199, 0.039636, 0.031453, 0.023382, 0.022467, 0.028902, 0.036582, 0.044663, 0.053152, 0.061534, 0.066606, 0.073470, 0.081511, 0.087626, 0.089559
#*# 	  0.164869, 0.153095, 0.139811, 0.128478, 0.119214, 0.108175, 0.096153, 0.085317, 0.072859, 0.061465, 0.050981, 0.040768, 0.032701, 0.026854, 0.024704, 0.029990, 0.039233, 0.050333, 0.057960, 0.064887, 0.070384, 0.076306, 0.086088, 0.092993, 0.094147
#*# 	  0.174926, 0.164362, 0.153251, 0.144724, 0.135806, 0.124479, 0.113996, 0.103268, 0.092274, 0.083347, 0.072354, 0.063485, 0.054391, 0.048540, 0.047511, 0.054260, 0.063876, 0.075291, 0.084605, 0.089985, 0.096861, 0.103474, 0.112486, 0.120123, 0.125561
#*# 	  0.174895, 0.164225, 0.154102, 0.145087, 0.136403, 0.128043, 0.119417, 0.109021, 0.099107, 0.089855, 0.081327, 0.073106, 0.063007, 0.058459, 0.057958, 0.064535, 0.078272, 0.088525, 0.098355, 0.104687, 0.110798, 0.118977, 0.128294, 0.137909, 0.143684
#*# 	  0.183573, 0.174019, 0.162928, 0.154872, 0.147191, 0.138476, 0.130811, 0.122853, 0.115701, 0.107394, 0.098668, 0.090467, 0.082742, 0.076974, 0.080928, 0.087932, 0.100300, 0.110456, 0.118879, 0.127526, 0.133920, 0.141922, 0.155858, 0.167341, 0.176189
#*# 	  0.194762, 0.180896, 0.169985, 0.161950, 0.154417, 0.148974, 0.144793, 0.137768, 0.130555, 0.122453, 0.115186, 0.107748, 0.101690, 0.096906, 0.099444, 0.108721, 0.120562, 0.131032, 0.141646, 0.150045, 0.156759, 0.167052, 0.181728, 0.195508, 0.204372
#*# 	  0.199741, 0.188719, 0.178416, 0.172545, 0.169210, 0.167628, 0.165157, 0.158844, 0.151138, 0.143038, 0.137503, 0.129067, 0.122719, 0.121138, 0.122636, 0.133026, 0.145588, 0.156815, 0.168620, 0.177025, 0.184259, 0.195679, 0.209197, 0.222634, 0.236748
#*# 	  0.208597, 0.194615, 0.184618, 0.177569, 0.176171, 0.175191, 0.175020, 0.168246, 0.161645, 0.154268, 0.147327, 0.141562, 0.135736, 0.132995, 0.137519, 0.146229, 0.158897, 0.171986, 0.181411, 0.189369, 0.198167, 0.207637, 0.223719, 0.240573, 0.256946
#*# 	  0.230686, 0.218519, 0.205305, 0.199236, 0.196373, 0.195524, 0.193431, 0.189037, 0.182769, 0.175270, 0.168752, 0.162611, 0.157103, 0.154458, 0.156017, 0.164883, 0.179678, 0.191553, 0.202017, 0.210857, 0.220364, 0.234009, 0.250733, 0.271283, 0.297231
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
