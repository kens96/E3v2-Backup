;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01492
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 5000
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.3839198566246051,
#*# 	  1.8456543448128722,
#*# 	  0.7735177357319235,
#*# 	  0.12671479723917098,
#*# 	  0.3606441210754609,
#*# 	  1.0889700297343674,
#*# 	  -0.28630734431899413,
#*# 	  -1.256647688564048,
#*# 	  0.3191050000521953,
#*# 	  0.6475891050879432
#*# model_domain = 3.169832376245682e-07,3.2936575116750625e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 32.935743
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER K1 5.1.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.209265, 0.190527, 0.176060, 0.157256, 0.142009, 0.126448, 0.115315, 0.097799, 0.082031, 0.071069, 0.058855, 0.046393, 0.036581, 0.027751, 0.017471, 0.012713, 0.015816, 0.024692, 0.035386, 0.047544, 0.060541, 0.076187, 0.089969, 0.107581, 0.114444, 0.119867, 0.126217, 0.130588, 0.129295, 0.123598
#*# 	0.178270, 0.173912, 0.152030, 0.139479, 0.113905, 0.097789, 0.084609, 0.068201, 0.059043, 0.046866, 0.033044, 0.021043, 0.010277, 0.002052, -0.007182, -0.014404, -0.015279, -0.008515, 0.002382, 0.014782, 0.022783, 0.040252, 0.055610, 0.070006, 0.077793, 0.085450, 0.084097, 0.093129, 0.090694, 0.085535
#*# 	0.171181, 0.148165, 0.133740, 0.114364, 0.102348, 0.087991, 0.069112, 0.054474, 0.038520, 0.026287, 0.015097, 0.002920, -0.008870, -0.021376, -0.033281, -0.036898, -0.036229, -0.032064, -0.026526, -0.015991, 0.002683, 0.014052, 0.030500, 0.045469, 0.048596, 0.050943, 0.058939, 0.062356, 0.062050, 0.050594
#*# 	0.150162, 0.135210, 0.113154, 0.093666, 0.079113, 0.067241, 0.057731, 0.037046, 0.022709, 0.001791, -0.009914, -0.020824, -0.023301, -0.038250, -0.048720, -0.061682, -0.062683, -0.056570, -0.043710, -0.032319, -0.018161, -0.005958, 0.005903, 0.018507, 0.028682, 0.036587, 0.038746, 0.038958, 0.038091, 0.027068
#*# 	0.143897, 0.126915, 0.112147, 0.096901, 0.076934, 0.063125, 0.050266, 0.032541, 0.017222, 0.003983, -0.009077, -0.022071, -0.032127, -0.044040, -0.054623, -0.060866, -0.059915, -0.058184, -0.049132, -0.035167, -0.023185, -0.010182, 0.007192, 0.017155, 0.028361, 0.034605, 0.039461, 0.041817, 0.036583, 0.027925
#*# 	0.135779, 0.123537, 0.109229, 0.095826, 0.079473, 0.056955, 0.047953, 0.029497, 0.014981, 0.004939, -0.006768, -0.014243, -0.025838, -0.041406, -0.052028, -0.063514, -0.059782, -0.053828, -0.045526, -0.034409, -0.017746, -0.004967, 0.010269, 0.026204, 0.033483, 0.041732, 0.044895, 0.047260, 0.045912, 0.034525
#*# 	0.140832, 0.128621, 0.114013, 0.095722, 0.082668, 0.068920, 0.059617, 0.042884, 0.027012, 0.016353, 0.001407, -0.009237, -0.021404, -0.030265, -0.040735, -0.046697, -0.048649, -0.042394, -0.033834, -0.018460, -0.005920, 0.006233, 0.023450, 0.036789, 0.047186, 0.055696, 0.060932, 0.064964, 0.060066, 0.051727
#*# 	0.141915, 0.132696, 0.117710, 0.101166, 0.089613, 0.078848, 0.067720, 0.056018, 0.041936, 0.027696, 0.013342, 0.004025, -0.007646, -0.017192, -0.025354, -0.027558, -0.028622, -0.025529, -0.014389, -0.002327, 0.012922, 0.026349, 0.042042, 0.058411, 0.069659, 0.078055, 0.082993, 0.085735, 0.084270, 0.077180
#*# 	0.136996, 0.125033, 0.113356, 0.101864, 0.086713, 0.082316, 0.071579, 0.059974, 0.046838, 0.034894, 0.024136, 0.011985, 0.003142, -0.003923, -0.012263, -0.016733, -0.015153, -0.007667, 0.001796, 0.017397, 0.032500, 0.046262, 0.065045, 0.082158, 0.094113, 0.102293, 0.107827, 0.113593, 0.114645, 0.107138
#*# 	0.139347, 0.130335, 0.117686, 0.107359, 0.096261, 0.091473, 0.080039, 0.069084, 0.056527, 0.043696, 0.032232, 0.024008, 0.014485, 0.007080, -0.002475, -0.004879, -0.004016, 0.004153, 0.015330, 0.031092, 0.046829, 0.061044, 0.081810, 0.097641, 0.110439, 0.119885, 0.124309, 0.130601, 0.131375, 0.121897
#*# 	0.149476, 0.139910, 0.128080, 0.119481, 0.103680, 0.096227, 0.087627, 0.076773, 0.063504, 0.052263, 0.044650, 0.036661, 0.028876, 0.021510, 0.011277, 0.003098, 0.004522, 0.013016, 0.026256, 0.042161, 0.058692, 0.072787, 0.090640, 0.107585, 0.120431, 0.131365, 0.140291, 0.143778, 0.145198, 0.135897
#*# 	0.149024, 0.141102, 0.127708, 0.118580, 0.105929, 0.098950, 0.087057, 0.076789, 0.064857, 0.055022, 0.048584, 0.039231, 0.029987, 0.019740, 0.013789, 0.009130, 0.011532, 0.018412, 0.030128, 0.044451, 0.061432, 0.077355, 0.097062, 0.113554, 0.126207, 0.138297, 0.142739, 0.146537, 0.144934, 0.139310
#*# 	0.143727, 0.131443, 0.121921, 0.111503, 0.097778, 0.089123, 0.076898, 0.068670, 0.057678, 0.048317, 0.044864, 0.034639, 0.022377, 0.015799, 0.004326, 0.003862, 0.005401, 0.013390, 0.021483, 0.037599, 0.052841, 0.070119, 0.085093, 0.101134, 0.116671, 0.126855, 0.134786, 0.139420, 0.141293, 0.133982
#*# 	0.142619, 0.128539, 0.115689, 0.106543, 0.092446, 0.086715, 0.076087, 0.064462, 0.052660, 0.044227, 0.035734, 0.026419, 0.019371, 0.010159, 0.002297, -0.000855, 0.000211, 0.004973, 0.014050, 0.029945, 0.043056, 0.058968, 0.077648, 0.094432, 0.109370, 0.119678, 0.127301, 0.129621, 0.124745, 0.118918
#*# 	0.136126, 0.125509, 0.114246, 0.103451, 0.091646, 0.084689, 0.075003, 0.063466, 0.053819, 0.041670, 0.032079, 0.021452, 0.012774, 0.004223, 0.001492, 0.002418, -0.000257, 0.004008, 0.011696, 0.022144, 0.040338, 0.057801, 0.072818, 0.090106, 0.104904, 0.114445, 0.117632, 0.123875, 0.123617, 0.118849
#*# 	0.126830, 0.114327, 0.105556, 0.095430, 0.083411, 0.077538, 0.067710, 0.055190, 0.044028, 0.036483, 0.026189, 0.017447, 0.009220, 0.002052, -0.004179, -0.007732, -0.006165, -0.002030, 0.006453, 0.022686, 0.036013, 0.050323, 0.066490, 0.086050, 0.099390, 0.113060, 0.120604, 0.122582, 0.124006, 0.113888
#*# 	0.119194, 0.110748, 0.099703, 0.088070, 0.078557, 0.073234, 0.064345, 0.051302, 0.038685, 0.027692, 0.018335, 0.014047, 0.007700, 0.000592, -0.004702, -0.012743, -0.011507, -0.011006, 0.000278, 0.021160, 0.035730, 0.048631, 0.064297, 0.082154, 0.090868, 0.101414, 0.114324, 0.123363, 0.124530, 0.114109
#*# 	0.122466, 0.108057, 0.100726, 0.087351, 0.073633, 0.067491, 0.057929, 0.047770, 0.035588, 0.025923, 0.016558, 0.006034, -0.000915, -0.010665, -0.014989, -0.020269, -0.021048, -0.014120, -0.004687, 0.011008, 0.026957, 0.042125, 0.056691, 0.071133, 0.082483, 0.091494, 0.103176, 0.115006, 0.117940, 0.104011
#*# 	0.114052, 0.103620, 0.093593, 0.084025, 0.071501, 0.067438, 0.055372, 0.042036, 0.034300, 0.021568, 0.010689, 0.003559, -0.004702, -0.011032, -0.021548, -0.023197, -0.024131, -0.017023, -0.006169, 0.006953, 0.022740, 0.037631, 0.052520, 0.069801, 0.083458, 0.093179, 0.103958, 0.110319, 0.109873, 0.107222
#*# 	0.111661, 0.103826, 0.092398, 0.084018, 0.070521, 0.062153, 0.052351, 0.041331, 0.028058, 0.019177, 0.008611, -0.001084, -0.008811, -0.016483, -0.022806, -0.029257, -0.028460, -0.021758, -0.011613, -0.000006, 0.016790, 0.029856, 0.048311, 0.068651, 0.082832, 0.089620, 0.097839, 0.104799, 0.100831, 0.098564
#*# 	0.112909, 0.101480, 0.091738, 0.080008, 0.069208, 0.059051, 0.051806, 0.036790, 0.030103, 0.015967, 0.004857, -0.004829, -0.014445, -0.020550, -0.028212, -0.031449, -0.031274, -0.026980, -0.014618, 0.000073, 0.013401, 0.028659, 0.043538, 0.061297, 0.075109, 0.086448, 0.095663, 0.103164, 0.104459, 0.102931
#*# 	0.108583, 0.098044, 0.088010, 0.076712, 0.064800, 0.056083, 0.044419, 0.033233, 0.021245, 0.012420, 0.000385, -0.008051, -0.016455, -0.023910, -0.034383, -0.037187, -0.036314, -0.030538, -0.020379, -0.002757, 0.010885, 0.026023, 0.036731, 0.055158, 0.070726, 0.087562, 0.094602, 0.104005, 0.103141, 0.095374
#*# 	0.107410, 0.099949, 0.091724, 0.077601, 0.067260, 0.056126, 0.049894, 0.032866, 0.023708, 0.010178, 0.000224, -0.007098, -0.012874, -0.020565, -0.024099, -0.032605, -0.031212, -0.023844, -0.012707, 0.004097, 0.018591, 0.032914, 0.049014, 0.065394, 0.083631, 0.098538, 0.112146, 0.117049, 0.122142, 0.115964
#*# 	0.113464, 0.103437, 0.092504, 0.079310, 0.069346, 0.060004, 0.049223, 0.034825, 0.025533, 0.013758, 0.001778, -0.005831, -0.012220, -0.021584, -0.031218, -0.032973, -0.032808, -0.026343, -0.014471, -0.002601, 0.015267, 0.033275, 0.045169, 0.068156, 0.081120, 0.100206, 0.106593, 0.112935, 0.115977, 0.112041
#*# 	0.112044, 0.102603, 0.092497, 0.080328, 0.069627, 0.060641, 0.047328, 0.031054, 0.019293, 0.009720, -0.001018, -0.004756, -0.012987, -0.025245, -0.035944, -0.037949, -0.038467, -0.027429, -0.018712, -0.003981, 0.007441, 0.024727, 0.040335, 0.061417, 0.080433, 0.094572, 0.099868, 0.108319, 0.113219, 0.113885
#*# 	0.113962, 0.105888, 0.092847, 0.081989, 0.069191, 0.057646, 0.045295, 0.031260, 0.019471, 0.008821, -0.002148, -0.011927, -0.019234, -0.029557, -0.039991, -0.041662, -0.042025, -0.036252, -0.024451, -0.009726, 0.006237, 0.022237, 0.036284, 0.055152, 0.069677, 0.084274, 0.099018, 0.106729, 0.113526, 0.105411
#*# 	0.126205, 0.118841, 0.107988, 0.091249, 0.082878, 0.068996, 0.060484, 0.044647, 0.037145, 0.023978, 0.011534, 0.005012, -0.004445, -0.009900, -0.021258, -0.028216, -0.025723, -0.015557, -0.006362, 0.015065, 0.031003, 0.046214, 0.066084, 0.082883, 0.099591, 0.114692, 0.124674, 0.134683, 0.141474, 0.145825
#*# 	0.129254, 0.117027, 0.105357, 0.093060, 0.081603, 0.071946, 0.059885, 0.046561, 0.035504, 0.027773, 0.017298, 0.009110, 0.000418, -0.006318, -0.013322, -0.017323, -0.017332, -0.008617, 0.004158, 0.021295, 0.040358, 0.058948, 0.073938, 0.094235, 0.106940, 0.122274, 0.136009, 0.147524, 0.149478, 0.154926
#*# 	0.129526, 0.118328, 0.104568, 0.091749, 0.083405, 0.071518, 0.062479, 0.049037, 0.037878, 0.028738, 0.016800, 0.011325, 0.001715, -0.004856, -0.012476, -0.016408, -0.014442, -0.005453, 0.006851, 0.023136, 0.041979, 0.058495, 0.076973, 0.097299, 0.111449, 0.127435, 0.140251, 0.149062, 0.159934, 0.167432
#*# 	0.135022, 0.119357, 0.104574, 0.092449, 0.078758, 0.071198, 0.061212, 0.049961, 0.038937, 0.028285, 0.017823, 0.010462, 0.004794, -0.003918, -0.009713, -0.012628, -0.013781, -0.003020, 0.010595, 0.026260, 0.044691, 0.061686, 0.081969, 0.100851, 0.118351, 0.132987, 0.147530, 0.159089, 0.171949, 0.179192
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
