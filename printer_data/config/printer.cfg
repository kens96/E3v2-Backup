[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01204
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 5

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345]
;cs_pin: rpi:None

;[resonance_tester]
;accel_chip: adxl345
;probe_points:
;    112, 112, 20

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20

[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 51.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.5051225983378953,
#*# 	1.8195102390006643,
#*# 	0.7021231371548109,
#*# 	0.5179341351214521,
#*# 	0.4514142856553639,
#*# 	-0.08515172425706082,
#*# 	-0.27110137461058453,
#*# 	0.12857188619028087,
#*# 	0.2608578490457167,
#*# 	0.06999231648430079
#*# model_domain = 3.1657411074412126e-07,3.292824091111193e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 23.534723
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.168334, 0.157949, 0.146010, 0.141381, 0.136841, 0.134541, 0.129552, 0.124858, 0.121019, 0.117575, 0.115210, 0.114513, 0.114210, 0.117421, 0.130210, 0.146396, 0.168025, 0.189676, 0.212592, 0.236472, 0.249431, 0.252495, 0.252934, 0.251459, 0.243228
#*# 	  0.128115, 0.115549, 0.107346, 0.103086, 0.097945, 0.094010, 0.084957, 0.080726, 0.075212, 0.070893, 0.066312, 0.062012, 0.060644, 0.063437, 0.072504, 0.088348, 0.108103, 0.126959, 0.149611, 0.173880, 0.183783, 0.185798, 0.182757, 0.180331, 0.172225
#*# 	  0.101591, 0.088476, 0.081090, 0.075403, 0.068827, 0.064166, 0.055927, 0.047418, 0.041214, 0.034708, 0.030630, 0.026452, 0.023918, 0.025448, 0.034656, 0.046313, 0.067632, 0.088845, 0.109384, 0.126717, 0.137671, 0.139800, 0.136560, 0.131582, 0.121776
#*# 	  0.085200, 0.074011, 0.066266, 0.060043, 0.053378, 0.046707, 0.040265, 0.032315, 0.025426, 0.020672, 0.015133, 0.007947, 0.006542, 0.009924, 0.013247, 0.028538, 0.052005, 0.071413, 0.089227, 0.105550, 0.118125, 0.123918, 0.120786, 0.115400, 0.101627
#*# 	  0.062313, 0.055690, 0.051421, 0.044930, 0.037805, 0.032740, 0.026664, 0.020317, 0.013014, 0.007698, 0.003857, 0.000731, -0.001171, 0.001211, 0.010906, 0.027888, 0.045834, 0.067073, 0.086986, 0.103996, 0.116493, 0.124628, 0.127369, 0.124284, 0.110790
#*# 	  0.052587, 0.045954, 0.042514, 0.037062, 0.032066, 0.029903, 0.023785, 0.018887, 0.011644, 0.005632, 0.001918, -0.002469, -0.003853, -0.001033, 0.006618, 0.022109, 0.045121, 0.065713, 0.082240, 0.102851, 0.117323, 0.124949, 0.128547, 0.128113, 0.114573
#*# 	  0.045980, 0.039698, 0.037249, 0.033729, 0.030091, 0.029820, 0.026914, 0.021676, 0.016054, 0.009856, 0.007654, 0.004221, 0.002212, 0.005819, 0.016350, 0.036176, 0.054916, 0.074614, 0.095435, 0.116339, 0.131819, 0.139828, 0.144435, 0.145009, 0.137816
#*# 	  0.044794, 0.038788, 0.034947, 0.033336, 0.032354, 0.032444, 0.027107, 0.023331, 0.017878, 0.012018, 0.007363, 0.003485, 0.002369, 0.006353, 0.016397, 0.034536, 0.052730, 0.072666, 0.095501, 0.117999, 0.131763, 0.139933, 0.145443, 0.146371, 0.139512
#*# 	  0.044175, 0.037159, 0.034137, 0.032960, 0.032520, 0.029639, 0.024673, 0.020054, 0.014992, 0.010979, 0.007391, 0.002883, 0.000447, 0.004856, 0.015153, 0.032783, 0.051581, 0.073546, 0.095436, 0.115772, 0.130965, 0.137841, 0.143007, 0.144042, 0.136993
#*# 	  0.039889, 0.035093, 0.030614, 0.027567, 0.025904, 0.022707, 0.019404, 0.015596, 0.010434, 0.006402, 0.002888, -0.001540, -0.004357, -0.000965, 0.011351, 0.028663, 0.048271, 0.067059, 0.090097, 0.110446, 0.124137, 0.134442, 0.139607, 0.138486, 0.132512
#*# 	  0.027923, 0.023451, 0.021735, 0.017784, 0.019469, 0.016668, 0.011421, 0.007632, 0.006984, 0.003231, -0.002142, -0.004926, -0.005418, -0.002414, 0.007987, 0.024071, 0.045174, 0.066824, 0.086404, 0.106829, 0.123584, 0.133985, 0.139541, 0.142878, 0.133527
#*# 	  0.033578, 0.029167, 0.023761, 0.022999, 0.021901, 0.018048, 0.015451, 0.011513, 0.005626, 0.001112, -0.003029, -0.005574, -0.008475, -0.005338, 0.003205, 0.018359, 0.037162, 0.054668, 0.078342, 0.099136, 0.110810, 0.121115, 0.128357, 0.129495, 0.124525
#*# 	  0.038717, 0.030861, 0.028484, 0.025815, 0.024985, 0.021916, 0.015670, 0.010026, 0.004685, -0.000636, -0.003502, -0.007349, -0.009784, -0.007889, -0.003220, 0.009219, 0.027191, 0.046704, 0.066585, 0.085860, 0.100613, 0.111261, 0.117550, 0.116517, 0.110870
#*# 	  0.029411, 0.024245, 0.024072, 0.021891, 0.021733, 0.018796, 0.012192, 0.007749, 0.003452, -0.001953, -0.004580, -0.005689, -0.008305, -0.008515, -0.001978, 0.011869, 0.031479, 0.051261, 0.072577, 0.091767, 0.104628, 0.115585, 0.123673, 0.121868, 0.118506
#*# 	  0.032986, 0.028228, 0.025626, 0.022752, 0.020626, 0.017916, 0.012799, 0.007298, 0.001937, -0.003378, -0.008387, -0.013303, -0.016403, -0.016125, -0.008734, 0.006003, 0.024460, 0.041951, 0.062036, 0.080341, 0.095371, 0.106171, 0.109974, 0.113348, 0.109369
#*# 	  0.040580, 0.037546, 0.032194, 0.029119, 0.027473, 0.022253, 0.015310, 0.011190, 0.005044, -0.001671, -0.005582, -0.011942, -0.014976, -0.015406, -0.008200, 0.006227, 0.025875, 0.043637, 0.061535, 0.079999, 0.094934, 0.105307, 0.110477, 0.112660, 0.107537
#*# 	  0.047859, 0.042265, 0.037992, 0.032741, 0.031208, 0.024088, 0.018056, 0.012669, 0.005429, -0.000526, -0.007295, -0.012761, -0.016686, -0.017405, -0.011870, 0.002049, 0.020302, 0.036841, 0.053986, 0.072830, 0.085794, 0.096107, 0.103322, 0.105072, 0.099020
#*# 	  0.058927, 0.049636, 0.044264, 0.038033, 0.034093, 0.029409, 0.022689, 0.014245, 0.005051, -0.002341, -0.009083, -0.016101, -0.021343, -0.022623, -0.016986, -0.001907, 0.014500, 0.027899, 0.045239, 0.064080, 0.078149, 0.086511, 0.093900, 0.093636, 0.086980
#*# 	  0.064532, 0.058040, 0.052022, 0.047255, 0.040245, 0.034295, 0.025822, 0.017307, 0.008189, 0.000546, -0.005976, -0.012058, -0.018230, -0.020440, -0.014081, 0.000892, 0.018050, 0.033323, 0.048878, 0.067368, 0.082253, 0.089938, 0.096068, 0.098880, 0.090634
#*# 	  0.075363, 0.065176, 0.059822, 0.055131, 0.049218, 0.042617, 0.036564, 0.026955, 0.017165, 0.010001, 0.006112, -0.001606, -0.008168, -0.009113, -0.002033, 0.013015, 0.030037, 0.045696, 0.063930, 0.081899, 0.096481, 0.105629, 0.111722, 0.115253, 0.112870
#*# 	  0.082720, 0.073240, 0.068663, 0.062630, 0.056448, 0.048932, 0.039907, 0.031574, 0.022346, 0.013323, 0.006376, 0.000072, -0.006554, -0.008744, -0.004418, 0.009595, 0.028409, 0.047324, 0.062984, 0.079390, 0.095512, 0.107103, 0.113883, 0.115234, 0.106902
#*# 	  0.094547, 0.084526, 0.079190, 0.072752, 0.064568, 0.057281, 0.046873, 0.038882, 0.028856, 0.020978, 0.012244, 0.004747, -0.000502, -0.003294, 0.001107, 0.014247, 0.034365, 0.052675, 0.068378, 0.086127, 0.098632, 0.109871, 0.117366, 0.118245, 0.116742
#*# 	  0.111199, 0.099290, 0.090275, 0.082627, 0.072832, 0.065056, 0.056825, 0.048274, 0.035968, 0.027418, 0.019298, 0.010052, 0.003458, 0.003047, 0.006237, 0.019389, 0.036015, 0.051888, 0.070220, 0.088536, 0.103022, 0.113111, 0.119527, 0.120538, 0.119670
#*# 	  0.118644, 0.107844, 0.096882, 0.087228, 0.080612, 0.072168, 0.060693, 0.050804, 0.040482, 0.030255, 0.021572, 0.012666, 0.006583, 0.002939, 0.006058, 0.019319, 0.038255, 0.055740, 0.072030, 0.088799, 0.103764, 0.110997, 0.117294, 0.119366, 0.119018
#*# 	  0.126432, 0.114284, 0.103573, 0.094190, 0.085305, 0.078292, 0.068502, 0.058091, 0.048549, 0.038714, 0.029321, 0.020876, 0.013229, 0.009785, 0.015092, 0.030029, 0.044210, 0.058992, 0.078552, 0.094788, 0.107211, 0.119219, 0.127901, 0.131707, 0.139011
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
