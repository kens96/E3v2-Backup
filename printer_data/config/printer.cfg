;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01492
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 5000
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.3839198566246051,
#*# 	1.8456543448128722,
#*# 	0.7735177357319235,
#*# 	0.12671479723917098,
#*# 	0.3606441210754609,
#*# 	1.0889700297343674,
#*# 	-0.28630734431899413,
#*# 	-1.256647688564048,
#*# 	0.3191050000521953,
#*# 	0.6475891050879432
#*# model_domain = 3.169832376245682e-07,3.2936575116750625e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 32.935743
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER K1 5.1.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.158479, 0.148045, 0.134715, 0.118950, 0.104484, 0.091944, 0.077521, 0.063115, 0.047009, 0.035337, 0.025920, 0.010203, -0.001932, -0.009690, -0.023785, -0.030123, -0.031066, -0.027346, -0.021913, -0.012786, -0.004252, 0.004977, 0.014321, 0.023768, 0.028189, 0.027069, 0.028956, 0.026048, 0.018224, 0.003141
#*# 	  0.143700, 0.128875, 0.129379, 0.097013, 0.083559, 0.086243, 0.057233, 0.041501, 0.040224, 0.012205, -0.000598, 0.001347, -0.039458, -0.037055, -0.037334, -0.068659, -0.059665, -0.048526, -0.058798, -0.044827, -0.028493, -0.032511, -0.018386, -0.010475, -0.016208, -0.006317, -0.008750, -0.021131, -0.019539, -0.037417
#*# 	  0.131802, 0.113961, 0.100237, 0.082427, 0.070564, 0.056107, 0.042517, 0.023452, 0.008747, -0.002857, -0.018614, -0.031228, -0.044708, -0.057286, -0.069541, -0.077217, -0.080990, -0.081539, -0.076104, -0.067605, -0.060205, -0.050972, -0.041826, -0.035524, -0.033370, -0.032541, -0.036244, -0.040238, -0.047664, -0.067214
#*# 	  0.117567, 0.102061, 0.075309, 0.074393, 0.058496, 0.036254, 0.030431, 0.012855, -0.012451, -0.016495, -0.030505, -0.052989, -0.046630, -0.070245, -0.089425, -0.085214, -0.095834, -0.098807, -0.088345, -0.082243, -0.073606, -0.065938, -0.055210, -0.050358, -0.043692, -0.045732, -0.049006, -0.053245, -0.062668, -0.080700
#*# 	  0.113476, 0.099276, 0.088070, 0.072131, 0.056759, 0.042293, 0.029359, 0.013285, -0.003378, -0.016007, -0.027512, -0.045871, -0.057739, -0.065725, -0.082528, -0.090850, -0.093234, -0.095480, -0.091234, -0.081724, -0.076145, -0.065606, -0.055976, -0.049785, -0.046107, -0.042474, -0.046141, -0.051720, -0.058222, -0.080947
#*# 	  0.119117, 0.108459, 0.105654, 0.081075, 0.065743, 0.061719, 0.038849, 0.024608, 0.022113, -0.003851, -0.017565, -0.024100, -0.044366, -0.055669, -0.062318, -0.082373, -0.080992, -0.076956, -0.075429, -0.066971, -0.057294, -0.050772, -0.040531, -0.031273, -0.028246, -0.025487, -0.027120, -0.032872, -0.042084, -0.058553
#*# 	  0.123815, 0.110779, 0.101725, 0.087438, 0.071816, 0.061702, 0.051211, 0.031410, 0.023607, 0.009454, -0.010590, -0.018244, -0.030795, -0.048900, -0.054906, -0.061931, -0.071021, -0.065446, -0.058874, -0.053284, -0.041124, -0.034766, -0.024961, -0.014908, -0.009781, -0.009441, -0.004739, -0.012343, -0.022689, -0.034928
#*# 	  0.126338, 0.117130, 0.099340, 0.092253, 0.082404, 0.064915, 0.061682, 0.047237, 0.027169, 0.022757, 0.009107, -0.011252, -0.016445, -0.028024, -0.044639, -0.046225, -0.049462, -0.047771, -0.040659, -0.029980, -0.023116, -0.011938, -0.003316, 0.006496, 0.013735, 0.015731, 0.015072, 0.012135, 0.003633, -0.008316
#*# 	  0.127938, 0.115626, 0.106451, 0.096465, 0.083853, 0.077330, 0.067200, 0.056751, 0.044386, 0.032052, 0.023145, 0.007168, -0.002140, -0.010051, -0.023754, -0.029525, -0.029683, -0.026897, -0.020249, -0.008279, 0.000596, 0.010535, 0.022671, 0.030327, 0.038721, 0.046855, 0.038226, 0.040764, 0.039134, 0.015680
#*# 	  0.142976, 0.132588, 0.131339, 0.111573, 0.100395, 0.099945, 0.082992, 0.071009, 0.066470, 0.046575, 0.034168, 0.030318, 0.012135, 0.002078, -0.004720, -0.014880, -0.016407, -0.013233, -0.006580, 0.003368, 0.011737, 0.022363, 0.035749, 0.044701, 0.054151, 0.055773, 0.056099, 0.053234, 0.047391, 0.032248
#*# 	  0.144246, 0.129844, 0.128342, 0.116719, 0.099032, 0.098267, 0.088559, 0.069457, 0.064785, 0.055345, 0.035040, 0.033318, 0.023000, 0.006689, 0.003972, -0.002620, -0.011627, -0.002102, 0.007640, 0.013413, 0.029679, 0.039558, 0.049112, 0.064845, 0.069961, 0.071284, 0.078163, 0.072584, 0.064825, 0.055507
#*# 	  0.143086, 0.135177, 0.119186, 0.117736, 0.107414, 0.093784, 0.089636, 0.077582, 0.061246, 0.057984, 0.049385, 0.033048, 0.029579, 0.019547, 0.006262, 0.004156, 0.002868, 0.007377, 0.012858, 0.024511, 0.038282, 0.046428, 0.060608, 0.075468, 0.075308, 0.083419, 0.089308, 0.078814, 0.078665, 0.061838
#*# 	  0.139149, 0.130903, 0.124348, 0.111082, 0.105477, 0.094312, 0.084748, 0.078424, 0.062529, 0.052330, 0.049274, 0.033324, 0.023317, 0.022575, 0.004108, -0.001907, 0.005453, -0.002228, 0.006063, 0.022987, 0.018113, 0.037827, 0.057024, 0.051102, 0.068360, 0.082971, 0.062336, 0.072827, 0.076896, 0.043784
#*# 	  0.129332, 0.122512, 0.124125, 0.106401, 0.095250, 0.096424, 0.079972, 0.068330, 0.064499, 0.049886, 0.041180, 0.034961, 0.020991, 0.010838, 0.002375, -0.003296, -0.005290, -0.004578, 0.004500, 0.013831, 0.020067, 0.036939, 0.049313, 0.053937, 0.068352, 0.072529, 0.066718, 0.082078, 0.066990, 0.050918
#*# 	  0.127039, 0.112828, 0.112852, 0.101361, 0.087520, 0.086354, 0.078586, 0.057980, 0.058470, 0.048122, 0.030012, 0.029150, 0.021079, 0.002305, 0.003464, -0.001498, -0.010585, 0.004040, 0.005511, 0.015147, 0.027541, 0.038961, 0.050373, 0.064597, 0.070028, 0.072068, 0.079437, 0.075936, 0.070471, 0.063008
#*# 	  0.119947, 0.112965, 0.099442, 0.095875, 0.087360, 0.076352, 0.074499, 0.063358, 0.046323, 0.044531, 0.035510, 0.022094, 0.017764, 0.009161, -0.001945, -0.004827, -0.007431, -0.002557, 0.002883, 0.013383, 0.029588, 0.036532, 0.049076, 0.066748, 0.067319, 0.073734, 0.082358, 0.074931, 0.070442, 0.056111
#*# 	  0.114851, 0.112264, 0.101586, 0.090871, 0.087330, 0.075036, 0.069044, 0.061737, 0.046962, 0.037436, 0.032483, 0.017649, 0.009013, 0.008790, -0.020819, -0.014517, -0.007340, -0.024023, -0.007612, 0.009472, 0.005254, 0.024742, 0.045037, 0.037911, 0.055808, 0.071331, 0.051022, 0.062877, 0.057981, 0.034080
#*# 	  0.116199, 0.108229, 0.107377, 0.090305, 0.080034, 0.080375, 0.063963, 0.051900, 0.048567, 0.031488, 0.021817, 0.016601, 0.002578, -0.006669, -0.016209, -0.022429, -0.026389, -0.025237, -0.017061, -0.006296, 0.000542, 0.015110, 0.026694, 0.031460, 0.045380, 0.049607, 0.044998, 0.051729, 0.047380, 0.032676
#*# 	  0.112392, 0.096100, 0.097055, 0.086223, 0.068998, 0.071141, 0.063545, 0.041957, 0.040678, 0.030666, 0.010029, 0.018648, 0.000643, -0.017177, -0.011010, -0.025260, -0.034229, -0.018424, -0.018702, -0.008902, 0.005595, 0.014103, 0.024858, 0.038425, 0.044929, 0.049891, 0.057790, 0.053176, 0.048957, 0.042490
#*# 	  0.107783, 0.099085, 0.088919, 0.082272, 0.072657, 0.062461, 0.058285, 0.046650, 0.033169, 0.027545, 0.014999, 0.005706, -0.001888, -0.012038, -0.020296, -0.024812, -0.026960, -0.023792, -0.017054, -0.007476, 0.009178, 0.013884, 0.026085, 0.043309, 0.046930, 0.054176, 0.063176, 0.055951, 0.053424, 0.044250
#*# 	  0.102933, 0.098480, 0.089730, 0.078547, 0.072127, 0.061239, 0.053773, 0.048606, 0.023937, 0.021486, 0.018715, -0.007346, -0.007715, -0.007099, -0.036999, -0.030664, -0.024212, -0.039022, -0.021974, -0.004403, -0.008671, 0.008787, 0.022493, 0.025311, 0.042021, 0.048078, 0.043701, 0.054191, 0.050888, 0.034305
#*# 	  0.103469, 0.093654, 0.091937, 0.077362, 0.066410, 0.064750, 0.050519, 0.037782, 0.034441, 0.017473, 0.005816, -0.000079, -0.010242, -0.021395, -0.031063, -0.036181, -0.037592, -0.036405, -0.027075, -0.015661, -0.008219, 0.006179, 0.018893, 0.023760, 0.039415, 0.046755, 0.042277, 0.051822, 0.048212, 0.033610
#*# 	  0.101906, 0.090053, 0.086355, 0.073376, 0.058485, 0.063707, 0.046407, 0.027708, 0.034157, 0.014168, -0.007392, 0.001953, -0.015946, -0.035965, -0.024742, -0.042478, -0.054709, -0.032005, -0.034797, -0.030911, -0.003333, 0.000439, 0.011659, 0.033242, 0.031743, 0.038481, 0.055900, 0.044740, 0.042241, 0.049373
#*# 	  0.102843, 0.093000, 0.077733, 0.072524, 0.062719, 0.048470, 0.044079, 0.030792, 0.012709, 0.007877, -0.003953, -0.019696, -0.023055, -0.032881, -0.047086, -0.049646, -0.053460, -0.050762, -0.041595, -0.032107, -0.018038, -0.009951, 0.002199, 0.017983, 0.021723, 0.028702, 0.037512, 0.034202, 0.031397, 0.019689
#*# 	  0.102761, 0.095450, 0.079098, 0.072325, 0.064468, 0.046311, 0.040766, 0.032001, 0.006011, 0.002759, -0.001756, -0.029524, -0.028442, -0.031775, -0.058323, -0.057219, -0.052589, -0.065746, -0.050362, -0.040131, -0.032158, -0.018455, -0.006272, -0.000921, 0.013193, 0.020483, 0.016396, 0.027160, 0.024789, 0.007451
#*# 	  0.104124, 0.089379, 0.092183, 0.072207, 0.061736, 0.059766, 0.041140, 0.028319, 0.023327, 0.007524, -0.007415, -0.012185, -0.026903, -0.037481, -0.044953, -0.055164, -0.057688, -0.054051, -0.047028, -0.037652, -0.025769, -0.013095, -0.001660, 0.007768, 0.018761, 0.027066, 0.028939, 0.032003, 0.033579, 0.022931
#*# 	  0.107870, 0.092300, 0.097555, 0.078135, 0.059020, 0.065179, 0.046785, 0.028993, 0.033085, 0.012836, -0.007385, 0.000799, -0.016546, -0.035460, -0.029512, -0.041816, -0.043791, -0.035955, -0.030886, -0.019924, -0.004288, 0.004184, 0.018180, 0.033197, 0.040951, 0.048672, 0.060359, 0.057769, 0.057767, 0.056572
#*# 	  0.107364, 0.101627, 0.085196, 0.075811, 0.070518, 0.050488, 0.048545, 0.033682, 0.017096, 0.013582, 0.002015, -0.013556, -0.017692, -0.026107, -0.041686, -0.041549, -0.043219, -0.039681, -0.031319, -0.017889, -0.006672, 0.006703, 0.020025, 0.034492, 0.042965, 0.050872, 0.057600, 0.059949, 0.061591, 0.057219
#*# 	  0.100969, 0.094884, 0.076000, 0.070449, 0.066404, 0.045776, 0.041389, 0.034999, 0.011423, 0.008936, 0.006808, -0.018397, -0.019390, -0.027935, -0.044873, -0.043369, -0.044524, -0.046775, -0.030325, -0.018246, -0.007414, 0.008658, 0.022231, 0.032288, 0.045614, 0.054419, 0.056132, 0.065230, 0.068693, 0.061482
#*# 	  0.102504, 0.087813, 0.084962, 0.070316, 0.053415, 0.056197, 0.042879, 0.024196, 0.025261, 0.010487, -0.000786, -0.003619, -0.018762, -0.027849, -0.031648, -0.041514, -0.040955, -0.033804, -0.027616, -0.013741, -0.001204, 0.012950, 0.025521, 0.038727, 0.051687, 0.060498, 0.069359, 0.076919, 0.082114, 0.080968
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
