;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01492
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 220
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.374166106121123,
#*# 	1.8055497020829114,
#*# 	0.7413583058747208,
#*# 	0.2969583793870675,
#*# 	0.48964771586572314,
#*# 	0.6132384606657677,
#*# 	-0.3959039924513543,
#*# 	-0.5949401524302841,
#*# 	0.33968963348466646,
#*# 	0.32998542009163717
#*# model_domain = 3.16552665816649e-07,3.2935678922928883e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 28.519301
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.054976, 0.028293, 0.003202, -0.017951, -0.037109, -0.055246, -0.069425, -0.086549, -0.100946, -0.111604, -0.123237, -0.133759, -0.139934, -0.144653, -0.152833, -0.153822, -0.149187, -0.137142, -0.126062, -0.109943, -0.077314, -0.057166, -0.043479, -0.023024, -0.005032, 0.009647, 0.021197, 0.032691, 0.049466, 0.045348
#*# 	  0.043793, 0.016776, -0.004131, -0.014464, -0.033221, -0.060534, -0.090363, -0.107370, -0.123790, -0.119175, -0.117640, -0.141955, -0.134218, -0.143375, -0.180637, -0.182167, -0.162739, -0.151398, -0.124383, -0.110077, -0.089974, -0.080246, -0.066987, -0.049184, -0.024127, -0.009556, 0.010450, 0.018528, 0.021760, 0.020097
#*# 	  0.035369, 0.007259, -0.014595, -0.037575, -0.054486, -0.069441, -0.084008, -0.102980, -0.116995, -0.130795, -0.142714, -0.152063, -0.162340, -0.171218, -0.177588, -0.181970, -0.177889, -0.168530, -0.154053, -0.137803, -0.118403, -0.098315, -0.078617, -0.061111, -0.045801, -0.030739, -0.022428, -0.012616, -0.006841, -0.005192
#*# 	  0.026043, -0.011155, -0.031711, -0.046996, -0.065708, -0.082952, -0.088814, -0.105870, -0.141690, -0.144485, -0.156829, -0.168087, -0.177628, -0.186242, -0.202011, -0.198441, -0.186370, -0.186048, -0.171203, -0.153743, -0.135959, -0.117920, -0.096279, -0.079646, -0.062492, -0.050260, -0.041539, -0.031105, -0.023429, -0.027736
#*# 	  0.018607, -0.005239, -0.019945, -0.043457, -0.063062, -0.081478, -0.096278, -0.112897, -0.128214, -0.142259, -0.153856, -0.164874, -0.175682, -0.183256, -0.190918, -0.195950, -0.192778, -0.185158, -0.169751, -0.152343, -0.132349, -0.116104, -0.098599, -0.081584, -0.060197, -0.048899, -0.035143, -0.025764, -0.024073, -0.028331
#*# 	  0.028376, 0.006415, -0.008760, -0.035661, -0.055957, -0.053860, -0.068165, -0.094317, -0.108131, -0.130679, -0.142629, -0.145386, -0.145066, -0.153888, -0.169234, -0.174083, -0.176519, -0.167077, -0.147362, -0.127552, -0.106387, -0.091302, -0.073116, -0.052606, -0.035367, -0.022332, -0.009365, 0.001131, 0.004805, -0.000112
#*# 	  0.042210, 0.021123, 0.007048, -0.011591, -0.029885, -0.044594, -0.055041, -0.071355, -0.085647, -0.099390, -0.110457, -0.120129, -0.130648, -0.138756, -0.146792, -0.150271, -0.143638, -0.133722, -0.120208, -0.101643, -0.081876, -0.062146, -0.044281, -0.023814, -0.004012, 0.011700, 0.020954, 0.029970, 0.037586, 0.035580
#*# 	  0.055031, 0.034221, 0.023435, 0.004286, -0.012585, -0.022488, -0.033307, -0.048793, -0.061781, -0.074755, -0.086761, -0.095771, -0.105713, -0.120070, -0.119556, -0.117803, -0.112393, -0.107352, -0.090364, -0.073466, -0.054304, -0.036231, -0.013383, 0.009047, 0.025756, 0.041140, 0.052248, 0.062312, 0.069651, 0.066899
#*# 	  0.065915, 0.049653, 0.037817, 0.020641, 0.004956, -0.002155, -0.010402, -0.026573, -0.038924, -0.055870, -0.065939, -0.073195, -0.078595, -0.085792, -0.094046, -0.096077, -0.091799, -0.080391, -0.063142, -0.046211, -0.024703, -0.005761, 0.016667, 0.036600, 0.057973, 0.073769, 0.082430, 0.091839, 0.098322, 0.099228
#*# 	  0.077991, 0.058948, 0.049899, 0.037172, 0.020290, 0.012661, 0.002328, -0.009587, -0.021764, -0.033301, -0.050010, -0.051784, -0.053232, -0.059982, -0.071365, -0.071556, -0.067231, -0.056220, -0.037278, -0.019949, 0.001641, 0.022311, 0.044691, 0.066616, 0.087476, 0.101230, 0.115044, 0.123758, 0.126412, 0.130186
#*# 	  0.096041, 0.078311, 0.068332, 0.052905, 0.040668, 0.030103, 0.019696, 0.010435, -0.001881, -0.009689, -0.023319, -0.033959, -0.042752, -0.045786, -0.049864, -0.053240, -0.043572, -0.035042, -0.018894, -0.000255, 0.022216, 0.042734, 0.064604, 0.086568, 0.106937, 0.122720, 0.128603, 0.140349, 0.152750, 0.153534
#*# 	  0.098532, 0.085312, 0.079821, 0.065976, 0.051451, 0.042349, 0.031539, 0.024457, 0.013410, 0.000204, -0.008041, -0.014831, -0.022097, -0.029288, -0.033510, -0.037292, -0.030713, -0.020816, -0.003787, 0.015046, 0.036974, 0.061356, 0.082247, 0.099796, 0.119300, 0.130683, 0.147915, 0.161624, 0.168212, 0.168854
#*# 	  0.106566, 0.089928, 0.083465, 0.066372, 0.052091, 0.043793, 0.034265, 0.021147, 0.017111, 0.003612, -0.005768, -0.019892, -0.019378, -0.026223, -0.030761, -0.034060, -0.028956, -0.021756, -0.003896, 0.016143, 0.039621, 0.056176, 0.077218, 0.098681, 0.115989, 0.133280, 0.142358, 0.152903, 0.163716, 0.165655
#*# 	  0.104769, 0.093152, 0.086834, 0.077246, 0.062762, 0.052009, 0.040434, 0.028352, 0.017741, 0.010185, 0.001534, -0.011699, -0.014775, -0.021505, -0.025774, -0.028102, -0.023756, -0.014325, 0.000756, 0.018206, 0.035331, 0.053384, 0.079363, 0.104347, 0.122879, 0.140940, 0.145003, 0.157029, 0.163388, 0.154996
#*# 	  0.116797, 0.099328, 0.091522, 0.078550, 0.066050, 0.061039, 0.048776, 0.031330, 0.020154, 0.016857, 0.008878, 0.000411, -0.005475, -0.013432, -0.015945, -0.012955, -0.013735, -0.004821, 0.008425, 0.029781, 0.046927, 0.067832, 0.088827, 0.107188, 0.127771, 0.140894, 0.148120, 0.161283, 0.177921, 0.177064
#*# 	  0.116994, 0.098987, 0.089700, 0.076826, 0.067786, 0.061361, 0.054126, 0.039743, 0.029894, 0.022197, 0.017742, 0.011419, 0.006260, -0.006842, -0.015446, -0.015131, -0.010831, 0.001978, 0.017899, 0.037161, 0.055907, 0.075626, 0.095943, 0.117974, 0.136928, 0.152932, 0.164612, 0.175605, 0.184383, 0.183702
#*# 	  0.114379, 0.099463, 0.093008, 0.082138, 0.068557, 0.062220, 0.055052, 0.043016, 0.032969, 0.027341, 0.016109, 0.010336, 0.003703, 0.004479, -0.005027, -0.013526, -0.002711, 0.008293, 0.023279, 0.042178, 0.061452, 0.082134, 0.102863, 0.124094, 0.144815, 0.157250, 0.171758, 0.185927, 0.194986, 0.194207
#*# 	  0.123735, 0.105952, 0.101353, 0.087471, 0.075814, 0.065111, 0.057016, 0.048556, 0.040505, 0.034952, 0.026868, 0.014507, 0.009434, 0.003120, -0.002210, -0.004509, 0.001108, 0.011510, 0.028065, 0.045402, 0.065598, 0.085797, 0.100742, 0.123308, 0.145199, 0.160938, 0.174543, 0.185480, 0.195767, 0.192071
#*# 	  0.130561, 0.114397, 0.108687, 0.095352, 0.081602, 0.074900, 0.063742, 0.057130, 0.047652, 0.038099, 0.036466, 0.028472, 0.023306, 0.016259, 0.004228, 0.003063, 0.001616, 0.012943, 0.030636, 0.053056, 0.070481, 0.093038, 0.111708, 0.130864, 0.152351, 0.165988, 0.179047, 0.193361, 0.201552, 0.204957
#*# 	  0.143837, 0.125614, 0.123782, 0.107809, 0.092925, 0.081777, 0.073952, 0.059150, 0.053136, 0.039845, 0.031379, 0.024142, 0.022276, 0.018357, 0.013199, 0.010006, 0.012286, 0.023034, 0.039350, 0.057011, 0.079491, 0.099890, 0.121873, 0.134369, 0.153715, 0.171666, 0.176750, 0.186996, 0.194044, 0.196201
#*# 	  0.143128, 0.127021, 0.121414, 0.110302, 0.096996, 0.091480, 0.081833, 0.069035, 0.057716, 0.049499, 0.038102, 0.032823, 0.025160, 0.025676, 0.013934, 0.010995, 0.007517, 0.016848, 0.040684, 0.057611, 0.076382, 0.093697, 0.113828, 0.139476, 0.158499, 0.172776, 0.190412, 0.194293, 0.201368, 0.202692
#*# 	  0.153014, 0.136003, 0.129551, 0.115997, 0.103866, 0.095999, 0.087251, 0.074858, 0.063788, 0.053708, 0.042091, 0.034189, 0.027986, 0.022833, 0.019370, 0.013571, 0.018205, 0.029283, 0.044114, 0.061533, 0.079715, 0.099321, 0.124851, 0.144366, 0.164091, 0.174988, 0.177912, 0.189813, 0.197903, 0.199730
#*# 	  0.159715, 0.142233, 0.136727, 0.120615, 0.111025, 0.103697, 0.093432, 0.081684, 0.070452, 0.059409, 0.056031, 0.049128, 0.032028, 0.023839, 0.018058, 0.014113, 0.025583, 0.035923, 0.049944, 0.070011, 0.087256, 0.106183, 0.127224, 0.146245, 0.167422, 0.183450, 0.193683, 0.209872, 0.220281, 0.221403
#*# 	  0.165142, 0.150530, 0.139006, 0.126993, 0.115194, 0.113321, 0.102319, 0.095388, 0.084484, 0.069893, 0.060580, 0.047226, 0.040639, 0.046428, 0.040975, 0.037037, 0.039136, 0.049025, 0.063311, 0.079925, 0.099158, 0.118684, 0.139486, 0.160567, 0.180272, 0.197110, 0.210785, 0.224308, 0.233009, 0.236502
#*# 	  0.174490, 0.160223, 0.151968, 0.139968, 0.130062, 0.121782, 0.116007, 0.100772, 0.088267, 0.079378, 0.064460, 0.057319, 0.054765, 0.055004, 0.050823, 0.046469, 0.043813, 0.054055, 0.071033, 0.088104, 0.108368, 0.127231, 0.146392, 0.170361, 0.189807, 0.206124, 0.216520, 0.235284, 0.245851, 0.248115
#*# 	  0.188029, 0.172275, 0.161150, 0.150019, 0.148504, 0.139099, 0.122988, 0.111216, 0.097596, 0.090578, 0.077025, 0.072598, 0.065746, 0.057591, 0.053162, 0.049848, 0.054564, 0.062777, 0.078827, 0.098402, 0.119315, 0.137894, 0.156777, 0.178075, 0.198213, 0.216063, 0.228086, 0.244201, 0.252865, 0.261451
#*# 	  0.203525, 0.185119, 0.181620, 0.167025, 0.159005, 0.149450, 0.142248, 0.121539, 0.107736, 0.104825, 0.096169, 0.087089, 0.081790, 0.073746, 0.076549, 0.065141, 0.069191, 0.081189, 0.098580, 0.117248, 0.138119, 0.156602, 0.177783, 0.199066, 0.219835, 0.238041, 0.250199, 0.267656, 0.277884, 0.282838
#*# 	  0.216916, 0.194296, 0.183825, 0.174984, 0.165746, 0.154443, 0.148689, 0.137234, 0.121640, 0.108526, 0.105256, 0.094941, 0.085416, 0.082582, 0.079848, 0.078551, 0.079055, 0.091275, 0.105641, 0.126553, 0.146613, 0.165698, 0.185395, 0.206636, 0.228966, 0.245466, 0.258736, 0.276642, 0.291715, 0.292756
#*# 	  0.214397, 0.199482, 0.190055, 0.180222, 0.170737, 0.166072, 0.151940, 0.135154, 0.122693, 0.121429, 0.113351, 0.107208, 0.101082, 0.100278, 0.090261, 0.087818, 0.093452, 0.105381, 0.120714, 0.140968, 0.162629, 0.182636, 0.201410, 0.225600, 0.244203, 0.263727, 0.280311, 0.293891, 0.307727, 0.317230
#*# 	  0.233849, 0.218723, 0.204075, 0.191186, 0.188530, 0.178022, 0.168358, 0.159307, 0.147511, 0.141148, 0.129033, 0.123266, 0.127910, 0.121176, 0.113277, 0.110308, 0.118482, 0.130298, 0.146548, 0.169554, 0.188614, 0.212712, 0.235363, 0.259603, 0.280852, 0.296944, 0.313173, 0.334429, 0.350568, 0.357042
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
