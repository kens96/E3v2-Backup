[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01204
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 5

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345]
;cs_pin: rpi:None

;[resonance_tester]
;accel_chip: adxl345
;probe_points:
;    112, 112, 20

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20

[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 51.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.5051225983378953,
#*# 	1.8195102390006643,
#*# 	0.7021231371548109,
#*# 	0.5179341351214521,
#*# 	0.4514142856553639,
#*# 	-0.08515172425706082,
#*# 	-0.27110137461058453,
#*# 	0.12857188619028087,
#*# 	0.2608578490457167,
#*# 	0.06999231648430079
#*# model_domain = 3.1657411074412126e-07,3.292824091111193e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 23.534723
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.324515, 0.291897, 0.273034, 0.255316, 0.242655, 0.226766, 0.208821, 0.194152, 0.179356, 0.165930, 0.154979, 0.142605, 0.131492, 0.128075, 0.130560, 0.139517, 0.150532, 0.158266, 0.170819, 0.181906, 0.182726, 0.180945, 0.176572, 0.164872, 0.152884
#*# 	  0.259931, 0.238458, 0.220628, 0.207613, 0.193489, 0.178056, 0.162665, 0.146368, 0.130066, 0.117170, 0.102974, 0.087744, 0.076183, 0.070046, 0.068593, 0.076461, 0.085675, 0.091924, 0.102961, 0.114444, 0.111588, 0.105495, 0.096122, 0.084741, 0.070427
#*# 	  0.231034, 0.211340, 0.194651, 0.179385, 0.165050, 0.147040, 0.131439, 0.115235, 0.095956, 0.080620, 0.069917, 0.052247, 0.038435, 0.031268, 0.029421, 0.034512, 0.043926, 0.051869, 0.062955, 0.070962, 0.071368, 0.067714, 0.062951, 0.046874, 0.030477
#*# 	  0.210243, 0.192621, 0.178798, 0.164896, 0.146327, 0.128933, 0.110827, 0.094000, 0.075308, 0.060405, 0.047335, 0.031811, 0.015515, 0.006070, 0.003349, 0.008669, 0.019000, 0.025910, 0.034751, 0.043335, 0.045517, 0.042782, 0.036266, 0.023132, 0.002429
#*# 	  0.195864, 0.181125, 0.168221, 0.153720, 0.136325, 0.119312, 0.101894, 0.085791, 0.067814, 0.051820, 0.038048, 0.022298, 0.008013, 0.000304, -0.002436, 0.002894, 0.012112, 0.021542, 0.030408, 0.040561, 0.044130, 0.041008, 0.035768, 0.023967, 0.005050
#*# 	  0.182334, 0.168345, 0.154721, 0.142537, 0.128807, 0.115687, 0.099547, 0.084234, 0.067327, 0.051010, 0.038130, 0.023438, 0.008707, 0.002385, 0.002723, 0.009518, 0.018974, 0.027934, 0.040252, 0.051007, 0.054584, 0.055907, 0.052125, 0.039877, 0.026050
#*# 	  0.181926, 0.165077, 0.154003, 0.143330, 0.130393, 0.118890, 0.105895, 0.089018, 0.070552, 0.053417, 0.039090, 0.024377, 0.010658, 0.001418, 0.003229, 0.010158, 0.022364, 0.031300, 0.041008, 0.050651, 0.055795, 0.054619, 0.051730, 0.043334, 0.025986
#*# 	  0.173896, 0.160795, 0.147426, 0.138568, 0.131304, 0.118520, 0.104677, 0.090742, 0.073121, 0.053964, 0.038504, 0.023047, 0.014195, 0.007807, 0.007419, 0.013649, 0.024659, 0.035874, 0.047656, 0.058001, 0.062279, 0.064175, 0.058582, 0.051974, 0.038315
#*# 	  0.173252, 0.158585, 0.148384, 0.137189, 0.126101, 0.115438, 0.100018, 0.085474, 0.069837, 0.052153, 0.036066, 0.021464, 0.010407, 0.003245, 0.001663, 0.008699, 0.019316, 0.030779, 0.041889, 0.053175, 0.057659, 0.059820, 0.055902, 0.045938, 0.033135
#*# 	  0.167016, 0.155508, 0.142838, 0.134679, 0.123621, 0.108152, 0.093683, 0.079375, 0.063672, 0.047941, 0.033520, 0.019475, 0.006125, -0.000448, -0.001219, 0.006202, 0.017567, 0.027510, 0.039822, 0.050028, 0.055198, 0.056595, 0.053264, 0.044555, 0.029354
#*# 	  0.161341, 0.148602, 0.137612, 0.127315, 0.115871, 0.102287, 0.086099, 0.072438, 0.057981, 0.041707, 0.027423, 0.015470, 0.004034, -0.004157, -0.006924, 0.000994, 0.010734, 0.021004, 0.032558, 0.044164, 0.049486, 0.051976, 0.049617, 0.043666, 0.030017
#*# 	  0.162671, 0.148536, 0.135223, 0.125934, 0.115300, 0.101010, 0.087561, 0.072121, 0.056362, 0.041726, 0.027324, 0.013124, 0.001079, -0.006724, -0.009891, -0.003607, 0.003807, 0.012621, 0.024238, 0.033984, 0.038433, 0.040761, 0.037773, 0.032917, 0.018441
#*# 	  0.170789, 0.154146, 0.142134, 0.130067, 0.120229, 0.108078, 0.088582, 0.071548, 0.055491, 0.040275, 0.023518, 0.008366, -0.003869, -0.013255, -0.017509, -0.014480, -0.006851, 0.002114, 0.012056, 0.022539, 0.026424, 0.026804, 0.024719, 0.019434, 0.006657
#*# 	  0.170216, 0.154079, 0.142556, 0.129586, 0.118141, 0.104498, 0.085566, 0.068028, 0.050836, 0.034766, 0.018139, 0.001988, -0.012345, -0.023238, -0.029528, -0.027238, -0.017594, -0.010489, -0.001854, 0.006812, 0.009272, 0.007608, 0.005429, -0.000991, -0.012430
#*# 	  0.170024, 0.152929, 0.140876, 0.128700, 0.116212, 0.102603, 0.085370, 0.066186, 0.048957, 0.033638, 0.018080, 0.001801, -0.013929, -0.023773, -0.029104, -0.022075, -0.014752, -0.007546, 0.000537, 0.009619, 0.013038, 0.012941, 0.012189, 0.005389, -0.003891
#*# 	  0.179148, 0.161721, 0.149497, 0.135116, 0.121454, 0.105815, 0.090527, 0.069873, 0.050316, 0.033627, 0.017277, 0.000494, -0.013959, -0.025650, -0.029454, -0.022451, -0.017108, -0.010891, -0.002181, 0.005694, 0.010389, 0.010483, 0.009231, 0.002507, -0.010876
#*# 	  0.183386, 0.169186, 0.158747, 0.145335, 0.127168, 0.110756, 0.091151, 0.070834, 0.051859, 0.033427, 0.016328, 0.000111, -0.015691, -0.026853, -0.035251, -0.030901, -0.022328, -0.017121, -0.009617, -0.002470, 0.000426, 0.001043, -0.001089, -0.006699, -0.020992
#*# 	  0.193495, 0.186954, 0.182162, 0.170596, 0.149315, 0.119849, 0.092475, 0.072278, 0.051787, 0.033981, 0.013849, -0.004092, -0.017688, -0.031721, -0.038009, -0.034742, -0.029191, -0.024304, -0.017556, -0.008627, -0.005723, -0.003257, -0.006958, -0.015240, -0.028356
#*# 	  0.214190, 0.215641, 0.225537, 0.219379, 0.181278, 0.140010, 0.103327, 0.077067, 0.054263, 0.036597, 0.017291, -0.001917, -0.018928, -0.033628, -0.039383, -0.037353, -0.030888, -0.025373, -0.020559, -0.014823, -0.012610, -0.011565, -0.014253, -0.022438, -0.038179
#*# 	  0.229433, 0.244596, 0.269977, 0.266618, 0.214820, 0.158286, 0.110378, 0.082007, 0.058533, 0.038413, 0.020518, 0.001624, -0.018289, -0.031686, -0.038592, -0.036430, -0.030815, -0.024841, -0.018504, -0.012312, -0.009936, -0.010011, -0.013469, -0.020368, -0.035021
#*# 	  0.241186, 0.264246, 0.291298, 0.288804, 0.235141, 0.169172, 0.119885, 0.092598, 0.068270, 0.047491, 0.028411, 0.011385, -0.006949, -0.020049, -0.029099, -0.024364, -0.018906, -0.013241, -0.006383, -0.000312, 0.002556, 0.005221, 0.002224, -0.005862, -0.019525
#*# 	  0.256164, 0.266239, 0.284085, 0.276899, 0.232862, 0.175182, 0.130248, 0.102193, 0.078590, 0.056733, 0.038093, 0.019075, 0.002107, -0.011218, -0.019275, -0.015859, -0.009201, -0.004896, 0.000571, 0.009119, 0.012210, 0.014788, 0.012182, 0.005240, -0.006303
#*# 	  0.263654, 0.261475, 0.261872, 0.250154, 0.215095, 0.173769, 0.137917, 0.111548, 0.086324, 0.065340, 0.045405, 0.024544, 0.005168, -0.007408, -0.015643, -0.012805, -0.006457, -0.000827, 0.005111, 0.012154, 0.015725, 0.015702, 0.014306, 0.007651, -0.005209
#*# 	  0.260497, 0.249808, 0.236648, 0.218793, 0.194166, 0.166365, 0.137690, 0.111106, 0.088765, 0.067219, 0.047873, 0.027478, 0.005710, -0.007024, -0.013853, -0.011537, -0.004049, -0.000193, 0.006330, 0.013179, 0.015675, 0.014386, 0.012555, 0.008641, -0.001640
#*# 	  0.270385, 0.251815, 0.231638, 0.214048, 0.190295, 0.169904, 0.147756, 0.123315, 0.098222, 0.075140, 0.053337, 0.033205, 0.013680, -0.001585, -0.008697, -0.007607, -0.002940, 0.001111, 0.008570, 0.013478, 0.015697, 0.017250, 0.017749, 0.011535, 0.011727
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
