[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01225
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic
adaptive_margin: 5

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20

[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 4250
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.4743296059104494,
#*# 	1.8223325033784241,
#*# 	0.7864523960245619,
#*# 	0.11907224163864813,
#*# 	0.33568975158409037,
#*# 	1.199123187163946,
#*# 	-0.22195753078260652,
#*# 	-1.3713505505473869,
#*# 	0.2757985948453994,
#*# 	0.682464273273622
#*# model_domain = 3.1549408902798945e-07,3.29169949814324e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 18.782749
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.164739, 0.144944, 0.131434, 0.102711, 0.080032, 0.065103, 0.044252, 0.022680, 0.003164, -0.015584, -0.037995, -0.067693, -0.082967, -0.102194, -0.123933, -0.139393, -0.153898, -0.169277, -0.176004, -0.175525, -0.181799, -0.188192, -0.194537, -0.207603, -0.218696, -0.230961, -0.248668, -0.270129, -0.297904, -0.332012
#*# 	  0.159833, 0.142113, 0.124517, 0.096950, 0.077725, 0.057392, 0.037743, 0.010896, -0.014744, -0.026686, -0.053934, -0.076516, -0.097130, -0.116135, -0.135893, -0.160356, -0.177828, -0.192796, -0.197786, -0.200074, -0.201950, -0.210209, -0.217409, -0.231456, -0.237931, -0.254323, -0.274136, -0.299283, -0.326917, -0.358234
#*# 	  0.169818, 0.148950, 0.128829, 0.110043, 0.084544, 0.070258, 0.051787, 0.023456, 0.002315, -0.021050, -0.050311, -0.069824, -0.095038, -0.114194, -0.143369, -0.162710, -0.177169, -0.191178, -0.196394, -0.201947, -0.202706, -0.209335, -0.217337, -0.233811, -0.241627, -0.254722, -0.276536, -0.301277, -0.333215, -0.359311
#*# 	  0.179256, 0.160547, 0.142506, 0.114338, 0.094549, 0.076438, 0.054602, 0.029771, 0.017152, -0.004172, -0.029596, -0.065819, -0.096075, -0.123188, -0.145259, -0.152716, -0.163065, -0.177744, -0.191632, -0.194852, -0.200673, -0.205959, -0.220809, -0.223705, -0.233099, -0.251453, -0.268990, -0.291318, -0.321717, -0.354250
#*# 	  0.188648, 0.174614, 0.158928, 0.131778, 0.105071, 0.084697, 0.069572, 0.043989, 0.021210, -0.001290, -0.022137, -0.049439, -0.074251, -0.102044, -0.122531, -0.137704, -0.157556, -0.171368, -0.173493, -0.183872, -0.186240, -0.190657, -0.197203, -0.204640, -0.211704, -0.228118, -0.248203, -0.270218, -0.298814, -0.329090
#*# 	  0.197816, 0.185172, 0.165158, 0.142252, 0.123020, 0.112948, 0.084466, 0.051850, 0.037179, 0.018240, -0.008956, -0.030038, -0.041702, -0.064926, -0.088546, -0.115980, -0.139201, -0.147661, -0.148920, -0.143187, -0.147340, -0.156320, -0.163816, -0.172558, -0.184552, -0.194083, -0.211379, -0.231093, -0.260723, -0.291670
#*# 	  0.209286, 0.195456, 0.185391, 0.164044, 0.137190, 0.120359, 0.102559, 0.078216, 0.057699, 0.037310, 0.015221, -0.009106, -0.027919, -0.049301, -0.074853, -0.093288, -0.107129, -0.118657, -0.118821, -0.122645, -0.127096, -0.131496, -0.138146, -0.147045, -0.153445, -0.168655, -0.181475, -0.203269, -0.230734, -0.258633
#*# 	  0.214956, 0.197675, 0.182521, 0.155933, 0.134228, 0.115478, 0.107455, 0.093922, 0.078856, 0.049744, 0.026300, -0.000555, -0.016903, -0.043799, -0.057061, -0.068422, -0.082963, -0.096250, -0.097161, -0.099061, -0.103626, -0.106327, -0.111428, -0.115047, -0.121713, -0.134320, -0.151463, -0.169453, -0.194334, -0.225184
#*# 	  0.227866, 0.209097, 0.200248, 0.176124, 0.159893, 0.142849, 0.129904, 0.107107, 0.089337, 0.066244, 0.048054, 0.028189, 0.010219, -0.007434, -0.033682, -0.050113, -0.067702, -0.073036, -0.076331, -0.073945, -0.076265, -0.082550, -0.083555, -0.089705, -0.095148, -0.108914, -0.122513, -0.140393, -0.167087, -0.194771
#*# 	  0.240378, 0.225893, 0.215854, 0.200196, 0.175906, 0.163731, 0.148850, 0.131196, 0.100864, 0.084792, 0.065755, 0.053745, 0.035941, 0.008789, -0.012210, -0.030240, -0.048296, -0.055163, -0.051081, -0.052027, -0.057611, -0.060658, -0.062655, -0.068986, -0.071481, -0.081663, -0.098826, -0.113100, -0.138166, -0.168450
#*# 	  0.253696, 0.237622, 0.224312, 0.207213, 0.189773, 0.176856, 0.164583, 0.145325, 0.125225, 0.109091, 0.080531, 0.064162, 0.047008, 0.032053, 0.006544, -0.009883, -0.030186, -0.032802, -0.030859, -0.032627, -0.036499, -0.034430, -0.038586, -0.053650, -0.057382, -0.058036, -0.072975, -0.088888, -0.105563, -0.131601
#*# 	  0.254568, 0.243123, 0.229823, 0.211791, 0.197322, 0.184825, 0.170473, 0.154884, 0.138563, 0.122275, 0.093523, 0.068459, 0.056293, 0.038487, 0.014505, 0.000878, -0.010869, -0.020799, -0.022152, -0.021270, -0.024002, -0.029753, -0.032099, -0.032744, -0.036303, -0.044126, -0.053178, -0.069875, -0.091627, -0.114947
#*# 	  0.245270, 0.233307, 0.224986, 0.208591, 0.188338, 0.178253, 0.165694, 0.146601, 0.131036, 0.111050, 0.097101, 0.067572, 0.045112, 0.024762, 0.001447, -0.003865, -0.018430, -0.028168, -0.018350, -0.021985, -0.031929, -0.033386, -0.037103, -0.049322, -0.049073, -0.045270, -0.043763, -0.069740, -0.090095, -0.111071
#*# 	  0.249428, 0.234829, 0.220082, 0.202183, 0.186478, 0.174027, 0.155220, 0.138434, 0.120770, 0.098829, 0.076311, 0.060344, 0.042182, 0.027804, 0.002900, -0.011560, -0.027974, -0.035948, -0.032449, -0.038745, -0.042255, -0.041844, -0.045331, -0.046084, -0.051970, -0.054696, -0.064111, -0.077151, -0.098060, -0.126043
#*# 	  0.240037, 0.230375, 0.219787, 0.204366, 0.184171, 0.171391, 0.157331, 0.134927, 0.119602, 0.101822, 0.078608, 0.054735, 0.024611, 0.012625, -0.001914, -0.016385, -0.032347, -0.031159, -0.033869, -0.045702, -0.047592, -0.061820, -0.063778, -0.053213, -0.056171, -0.049013, -0.073952, -0.086039, -0.106923, -0.132663
#*# 	  0.231145, 0.221287, 0.207687, 0.192510, 0.176928, 0.165978, 0.153077, 0.131930, 0.112550, 0.095933, 0.071185, 0.053421, 0.034966, 0.014292, -0.003103, -0.019676, -0.035386, -0.042471, -0.043878, -0.043498, -0.043088, -0.043746, -0.047781, -0.047523, -0.051839, -0.057435, -0.069621, -0.080606, -0.090424, -0.116342
#*# 	  0.234532, 0.221829, 0.210505, 0.193702, 0.180391, 0.161775, 0.147534, 0.119742, 0.103103, 0.081202, 0.068006, 0.063381, 0.029558, 0.011093, -0.008485, -0.024108, -0.028080, -0.036955, -0.059083, -0.054466, -0.059899, -0.059112, -0.039604, -0.040922, -0.054746, -0.064229, -0.070164, -0.084786, -0.092042, -0.114984
#*# 	  0.235680, 0.220279, 0.201907, 0.185050, 0.171664, 0.157938, 0.140017, 0.123794, 0.104494, 0.086368, 0.071369, 0.046514, 0.029414, 0.009242, -0.013058, -0.028014, -0.043167, -0.052068, -0.052982, -0.050375, -0.046889, -0.053956, -0.057811, -0.056800, -0.069707, -0.074934, -0.075330, -0.080079, -0.108482, -0.135805
#*# 	  0.227540, 0.213958, 0.196472, 0.180045, 0.162828, 0.152704, 0.137210, 0.120544, 0.098990, 0.071661, 0.048264, 0.036913, 0.028091, 0.007970, -0.010906, -0.029671, -0.053486, -0.060103, -0.061308, -0.071909, -0.071464, -0.072215, -0.075948, -0.066536, -0.070568, -0.066429, -0.077476, -0.085996, -0.108174, -0.146481
#*# 	  0.213089, 0.206780, 0.191118, 0.165492, 0.147473, 0.135601, 0.118307, 0.104838, 0.090350, 0.073729, 0.049333, 0.025526, 0.002876, -0.017726, -0.034775, -0.052592, -0.069576, -0.076464, -0.075755, -0.075052, -0.079279, -0.079229, -0.085765, -0.089763, -0.093064, -0.102219, -0.103882, -0.119475, -0.136433, -0.162790
#*# 	  0.215263, 0.194380, 0.182968, 0.175590, 0.143338, 0.132222, 0.124016, 0.097200, 0.075874, 0.057395, 0.026936, 0.006233, -0.004951, -0.027263, -0.048183, -0.066209, -0.078212, -0.081553, -0.081104, -0.091201, -0.091931, -0.104084, -0.107855, -0.102345, -0.104603, -0.112987, -0.123169, -0.144991, -0.146397, -0.173846
#*# 	  0.206184, 0.189994, 0.176755, 0.165805, 0.143887, 0.127391, 0.110266, 0.087533, 0.069131, 0.050208, 0.031623, 0.002007, -0.016763, -0.040543, -0.060613, -0.076624, -0.088975, -0.099184, -0.103517, -0.102559, -0.104526, -0.108909, -0.108741, -0.112486, -0.116361, -0.127397, -0.139535, -0.153773, -0.172310, -0.197893
#*# 	  0.208830, 0.191711, 0.179132, 0.164190, 0.140999, 0.129620, 0.110558, 0.082952, 0.061453, 0.046441, 0.023795, 0.004237, -0.007255, -0.029219, -0.058277, -0.073687, -0.090993, -0.100459, -0.103129, -0.104287, -0.113927, -0.108080, -0.111376, -0.110158, -0.112496, -0.122018, -0.138040, -0.153094, -0.168955, -0.191837
#*# 	  0.204441, 0.191628, 0.177477, 0.160649, 0.140751, 0.130391, 0.111400, 0.090105, 0.075289, 0.056580, 0.022362, 0.004275, -0.013082, -0.035625, -0.051025, -0.066854, -0.081627, -0.093388, -0.095146, -0.096864, -0.097146, -0.100909, -0.101671, -0.102985, -0.107337, -0.115040, -0.126971, -0.138600, -0.156099, -0.184433
#*# 	  0.197544, 0.183634, 0.169313, 0.154598, 0.139192, 0.122464, 0.104267, 0.085531, 0.066100, 0.048098, 0.023954, 0.006304, -0.016313, -0.034362, -0.051425, -0.066667, -0.089830, -0.097466, -0.099234, -0.106087, -0.108836, -0.104545, -0.098594, -0.103352, -0.114782, -0.120272, -0.130655, -0.151020, -0.168525, -0.183774
#*# 	  0.191986, 0.178326, 0.179373, 0.154545, 0.134388, 0.118023, 0.102576, 0.082308, 0.063592, 0.051748, 0.024736, 0.000952, -0.017131, -0.040456, -0.061644, -0.078301, -0.094079, -0.099998, -0.105227, -0.106466, -0.107120, -0.107135, -0.111214, -0.113823, -0.120338, -0.127403, -0.137106, -0.148725, -0.163335, -0.192795
#*# 	  0.193175, 0.179086, 0.171199, 0.152029, 0.135835, 0.121347, 0.107670, 0.084607, 0.064459, 0.047020, 0.022492, 0.004224, -0.013607, -0.036788, -0.060492, -0.078445, -0.093138, -0.104825, -0.104593, -0.106792, -0.110003, -0.112774, -0.115069, -0.118876, -0.122937, -0.130628, -0.141680, -0.155909, -0.174779, -0.193182
#*# 	  0.176761, 0.161905, 0.149500, 0.139107, 0.121186, 0.102700, 0.099031, 0.076982, 0.048150, 0.032037, 0.011295, -0.012798, -0.034540, -0.046333, -0.070782, -0.091579, -0.105564, -0.116770, -0.119435, -0.121492, -0.122509, -0.126098, -0.130458, -0.134032, -0.137711, -0.150082, -0.163253, -0.173450, -0.190563, -0.211288
#*# 	  0.157186, 0.138572, 0.124436, 0.114977, 0.101673, 0.088342, 0.076428, 0.053596, 0.032660, 0.017409, -0.005191, -0.026268, -0.047234, -0.066969, -0.083443, -0.109080, -0.131519, -0.134218, -0.136270, -0.139580, -0.139229, -0.136269, -0.148249, -0.154726, -0.156823, -0.167056, -0.178084, -0.190844, -0.206031, -0.225832
#*# 	  0.148706, 0.130064, 0.117048, 0.103301, 0.096133, 0.082986, 0.067839, 0.042553, 0.026200, 0.007375, -0.017967, -0.037029, -0.048930, -0.071831, -0.089950, -0.110018, -0.131243, -0.139196, -0.142480, -0.146336, -0.146140, -0.150093, -0.148375, -0.153434, -0.161019, -0.172501, -0.183046, -0.192864, -0.207115, -0.223026
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
