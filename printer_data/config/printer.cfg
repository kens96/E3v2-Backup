;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01492
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 150
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.3839198566246051,
#*# 	1.8456543448128722,
#*# 	0.7735177357319235,
#*# 	0.12671479723917098,
#*# 	0.3606441210754609,
#*# 	1.0889700297343674,
#*# 	-0.28630734431899413,
#*# 	-1.256647688564048,
#*# 	0.3191050000521953,
#*# 	0.6475891050879432
#*# model_domain = 3.169832376245682e-07,3.2936575116750625e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 32.935743
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER K1 5.1.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.168089, 0.163735, 0.151413, 0.132208, 0.115199, 0.101032, 0.087199, 0.069105, 0.054257, 0.042285, 0.030499, 0.017147, 0.005208, -0.006617, -0.014984, -0.023061, -0.024317, -0.021464, -0.011974, -0.002223, 0.008031, 0.018953, 0.030579, 0.040769, 0.048210, 0.049954, 0.052535, 0.053450, 0.048366, 0.033890
#*# 	0.179895, 0.148903, 0.130145, 0.112818, 0.097530, 0.083479, 0.067562, 0.052153, 0.038165, 0.022075, 0.009084, -0.003862, -0.018232, -0.030884, -0.042140, -0.050734, -0.053854, -0.057324, -0.043866, -0.036106, -0.021804, -0.015116, -0.004210, 0.005945, 0.009072, 0.012699, 0.009676, 0.010645, 0.005772, -0.004954
#*# 	0.145176, 0.128118, 0.107800, 0.091618, 0.082515, 0.063991, 0.046683, 0.030188, 0.012271, -0.000205, -0.015206, -0.028892, -0.042110, -0.051625, -0.066832, -0.074883, -0.079924, -0.078448, -0.073901, -0.063255, -0.057295, -0.044878, -0.035021, -0.027647, -0.022132, -0.021758, -0.020825, -0.021536, -0.029523, -0.045598
#*# 	0.129019, 0.128848, 0.094491, 0.080557, 0.063475, 0.048572, 0.033351, 0.005818, 0.002659, -0.014706, -0.019717, -0.042576, -0.054990, -0.070762, -0.082707, -0.090695, -0.093005, -0.093866, -0.086445, -0.081144, -0.066987, -0.057873, -0.049551, -0.039411, -0.035206, -0.032747, -0.034773, -0.036984, -0.039897, -0.055606
#*# 	0.131222, 0.116808, 0.102954, 0.084565, 0.069422, 0.053989, 0.038167, 0.021545, 0.005840, -0.010047, -0.024260, -0.036767, -0.051530, -0.066466, -0.079628, -0.084884, -0.088807, -0.089427, -0.083119, -0.074909, -0.064313, -0.055342, -0.045960, -0.037086, -0.030821, -0.027161, -0.028468, -0.032153, -0.037365, -0.054298
#*# 	0.142271, 0.118956, 0.104482, 0.087586, 0.072776, 0.060481, 0.045801, 0.028165, 0.013514, 0.001156, -0.013899, -0.029415, -0.045050, -0.054525, -0.066225, -0.075966, -0.079911, -0.081496, -0.073490, -0.061520, -0.052120, -0.043376, -0.033803, -0.023877, -0.015800, -0.014601, -0.011968, -0.013797, -0.022018, -0.038018
#*# 	0.134757, 0.121051, 0.108215, 0.092650, 0.077873, 0.068311, 0.053440, 0.041583, 0.024220, 0.008126, -0.002751, -0.020565, -0.032785, -0.042144, -0.051882, -0.061344, -0.066339, -0.061546, -0.057273, -0.045664, -0.038483, -0.028265, -0.016206, -0.004353, 0.001189, 0.003934, 0.007745, 0.005797, -0.002828, -0.016939
#*# 	0.137108, 0.142604, 0.113441, 0.099102, 0.084642, 0.075289, 0.065615, 0.038621, 0.038745, 0.024622, 0.023684, -0.002096, -0.014669, -0.027052, -0.037778, -0.042373, -0.047015, -0.043864, -0.034640, -0.024580, -0.015525, -0.005074, 0.008599, 0.019586, 0.026541, 0.030555, 0.032226, 0.031506, 0.027099, 0.013577
#*# 	0.143901, 0.131223, 0.122662, 0.108803, 0.097893, 0.087195, 0.078169, 0.065011, 0.051334, 0.040565, 0.027856, 0.012943, 0.003227, -0.007911, -0.021452, -0.025470, -0.024906, -0.021624, -0.014595, -0.005483, 0.006802, 0.018281, 0.030609, 0.038106, 0.051064, 0.057197, 0.056469, 0.057333, 0.052446, 0.040640
#*# 	0.150887, 0.139535, 0.127208, 0.115254, 0.103468, 0.096476, 0.084178, 0.072756, 0.062134, 0.048771, 0.032653, 0.025341, 0.012948, 0.001654, -0.010121, -0.016629, -0.018039, -0.013207, -0.006135, 0.003409, 0.017464, 0.028788, 0.038995, 0.052323, 0.060437, 0.065819, 0.067152, 0.064548, 0.062409, 0.052902
#*# 	0.147759, 0.141224, 0.130278, 0.120450, 0.109686, 0.100254, 0.089699, 0.077192, 0.065092, 0.055493, 0.044590, 0.033778, 0.023019, 0.009512, 0.005350, -0.001475, -0.002339, 0.001929, 0.011671, 0.023055, 0.035537, 0.047921, 0.061093, 0.076285, 0.085427, 0.088938, 0.090587, 0.101383, 0.090071, 0.078874
#*# 	0.153569, 0.155924, 0.134648, 0.122629, 0.112630, 0.102158, 0.093516, 0.074771, 0.069239, 0.058501, 0.054904, 0.038414, 0.028268, 0.019120, 0.008732, 0.003217, 0.001391, 0.005228, 0.012727, 0.026816, 0.035558, 0.047603, 0.062227, 0.075481, 0.083845, 0.087668, 0.091870, 0.098009, 0.089314, 0.075256
#*# 	0.143776, 0.136792, 0.126095, 0.117153, 0.105340, 0.095245, 0.084363, 0.072428, 0.061740, 0.051944, 0.041726, 0.032569, 0.022431, 0.013063, -0.004434, -0.004004, -0.005165, 0.002736, 0.006345, 0.017723, 0.029909, 0.041133, 0.053900, 0.060729, 0.074434, 0.080994, 0.093641, 0.085839, 0.082475, 0.071956
#*# 	0.139352, 0.128284, 0.118546, 0.109443, 0.098040, 0.092951, 0.082942, 0.068020, 0.054062, 0.051499, 0.041724, 0.035389, 0.018045, 0.011257, 0.002678, -0.005253, -0.005605, -0.002441, 0.006917, 0.014636, 0.023263, 0.040999, 0.053293, 0.063624, 0.073074, 0.079250, 0.083623, 0.084802, 0.079888, 0.070728
#*# 	0.131620, 0.122890, 0.114802, 0.103893, 0.092038, 0.089160, 0.079596, 0.069802, 0.056520, 0.047763, 0.037473, 0.027703, 0.018269, 0.001722, 0.002503, -0.003687, -0.003587, -0.000444, 0.005924, 0.015852, 0.029822, 0.044704, 0.055963, 0.066446, 0.076364, 0.085918, 0.091642, 0.093090, 0.085998, 0.078125
#*# 	0.127553, 0.127111, 0.108166, 0.096712, 0.086707, 0.082571, 0.073053, 0.056123, 0.052618, 0.042290, 0.031415, 0.024391, 0.015127, 0.006105, -0.001885, -0.007873, -0.008247, -0.006107, 0.001134, 0.009165, 0.024108, 0.032536, 0.050415, 0.060896, 0.069400, 0.076971, 0.081425, 0.088498, 0.081031, 0.070510
#*# 	0.123119, 0.116278, 0.106718, 0.092524, 0.087211, 0.077558, 0.068343, 0.054726, 0.044686, 0.034316, 0.025188, 0.016168, 0.006061, -0.004279, -0.013521, -0.017045, -0.020729, -0.012195, -0.008856, 0.001879, 0.011298, 0.023976, 0.036754, 0.042480, 0.058853, 0.063972, 0.077536, 0.070946, 0.068496, 0.058784
#*# 	0.124413, 0.114908, 0.102043, 0.093893, 0.083666, 0.075649, 0.067055, 0.055426, 0.036233, 0.032396, 0.022783, 0.015715, 0.000151, -0.010050, -0.019259, -0.024981, -0.029285, -0.025941, -0.018870, -0.004634, 0.002193, 0.012435, 0.026354, 0.039110, 0.047987, 0.051354, 0.057432, 0.061012, 0.056773, 0.048156
#*# 	0.119511, 0.108020, 0.101171, 0.090110, 0.077812, 0.073098, 0.062813, 0.057737, 0.040974, 0.030778, 0.018564, 0.008504, 0.001076, -0.016051, -0.016987, -0.023987, -0.021096, -0.023270, -0.013258, -0.000200, 0.009842, 0.018058, 0.032428, 0.046969, 0.055425, 0.063685, 0.066495, 0.072068, 0.069544, 0.058600
#*# 	0.120295, 0.116817, 0.100713, 0.088503, 0.077142, 0.072792, 0.062813, 0.048020, 0.039082, 0.028769, 0.015372, 0.005547, -0.004147, -0.012855, -0.020915, -0.026382, -0.028621, -0.027187, -0.015295, -0.007776, 0.004745, 0.014190, 0.027315, 0.041827, 0.052120, 0.059250, 0.062892, 0.075388, 0.066764, 0.055327
#*# 	0.115846, 0.105571, 0.097897, 0.083422, 0.075799, 0.066011, 0.062843, 0.045090, 0.031631, 0.023452, 0.012870, 0.000840, -0.007965, -0.015525, -0.023481, -0.030117, -0.031104, -0.027765, -0.019867, -0.009919, 0.003017, 0.014309, 0.026790, 0.031338, 0.048340, 0.058922, 0.076147, 0.066936, 0.065609, 0.058206
#*# 	0.113900, 0.105759, 0.094521, 0.083305, 0.073675, 0.067344, 0.053497, 0.040694, 0.029246, 0.020717, 0.005747, -0.001094, -0.010398, -0.019851, -0.030678, -0.037324, -0.036937, -0.032080, -0.024381, -0.015343, -0.002640, 0.012591, 0.022844, 0.033853, 0.045400, 0.055891, 0.060986, 0.063062, 0.070576, 0.058152
#*# 	0.114694, 0.105267, 0.093049, 0.082973, 0.072666, 0.061786, 0.051251, 0.045246, 0.027038, 0.014288, 0.002658, -0.006734, -0.015841, -0.036321, -0.036083, -0.042190, -0.034155, -0.039509, -0.029583, -0.023545, -0.008139, 0.004177, 0.014140, 0.029651, 0.039204, 0.047917, 0.055042, 0.057574, 0.056913, 0.048885
#*# 	0.118492, 0.113804, 0.093710, 0.084498, 0.072150, 0.062106, 0.051627, 0.036226, 0.022051, 0.010146, -0.000838, -0.014262, -0.021826, -0.031081, -0.042553, -0.049454, -0.050568, -0.047636, -0.041141, -0.027447, -0.017585, -0.006785, 0.008627, 0.020305, 0.029535, 0.036583, 0.043739, 0.052440, 0.046705, 0.040160
#*# 	0.116520, 0.106502, 0.094863, 0.077897, 0.071926, 0.060912, 0.053428, 0.029485, 0.020289, 0.007392, -0.007520, -0.016250, -0.027469, -0.038052, -0.050287, -0.055654, -0.060350, -0.056554, -0.048809, -0.035669, -0.026305, -0.016016, -0.002904, 0.006260, 0.021991, 0.029552, 0.041743, 0.040070, 0.040252, 0.031730
#*# 	0.123035, 0.110155, 0.101777, 0.086292, 0.074839, 0.063721, 0.050834, 0.035677, 0.017038, 0.011880, -0.001759, -0.008930, -0.024838, -0.034641, -0.044554, -0.050815, -0.055272, -0.052449, -0.040912, -0.029769, -0.019658, -0.008102, 0.005799, 0.019553, 0.030140, 0.037409, 0.044411, 0.051287, 0.053923, 0.043324
#*# 	0.128879, 0.114982, 0.105269, 0.092475, 0.079325, 0.069456, 0.056416, 0.043897, 0.030345, 0.021379, 0.010025, -0.002504, -0.013945, -0.029124, -0.032131, -0.037036, -0.035366, -0.035401, -0.027067, -0.012536, 0.000840, 0.012438, 0.024160, 0.038903, 0.052404, 0.063508, 0.068491, 0.075449, 0.077602, 0.071541
#*# 	0.128182, 0.121866, 0.104641, 0.089026, 0.078899, 0.068649, 0.055169, 0.041613, 0.032375, 0.018809, 0.004701, -0.003803, -0.013502, -0.024744, -0.033087, -0.038803, -0.038821, -0.034337, -0.024871, -0.014194, 0.002171, 0.016530, 0.026779, 0.042388, 0.055248, 0.065871, 0.071389, 0.080416, 0.082037, 0.078880
#*# 	0.123341, 0.113613, 0.099322, 0.084206, 0.076923, 0.064275, 0.061402, 0.041817, 0.027965, 0.017097, 0.009140, -0.003004, -0.011229, -0.020772, -0.030535, -0.035294, -0.035063, -0.031723, -0.019543, -0.008694, 0.006692, 0.021672, 0.035903, 0.050061, 0.061909, 0.073253, 0.084446, 0.089308, 0.093318, 0.095025
#*# 	0.127989, 0.115202, 0.105898, 0.087575, 0.077909, 0.067051, 0.056557, 0.042215, 0.027878, 0.021207, 0.006321, 0.005098, -0.010971, -0.020034, -0.029294, -0.034531, -0.034053, -0.027811, -0.019387, -0.006225, 0.006986, 0.022076, 0.035691, 0.050510, 0.063183, 0.075562, 0.087513, 0.093815, 0.100793, 0.104924
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
