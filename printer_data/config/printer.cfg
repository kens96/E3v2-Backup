;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.02059
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 5000
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.3916889371658787,
#*# 	1.8307830272806047,
#*# 	0.7396177182857652,
#*# 	0.3281756181118155,
#*# 	0.6075657980954182,
#*# 	0.4036643853866788,
#*# 	-0.6329817966384356,
#*# 	-0.302747821828245,
#*# 	0.44359129962667126,
#*# 	0.19096664171892128
#*# model_domain = 3.1718999427372645e-07,3.2932430273611936e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 20.689650
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.172916, 0.155633, 0.143434, 0.127112, 0.112519, 0.104194, 0.093764, 0.077312, 0.069160, 0.057814, 0.047365, 0.040186, 0.033417, 0.025342, 0.018269, 0.018023, 0.022831, 0.033314, 0.047508, 0.065098, 0.082235, 0.099260, 0.120366, 0.137525, 0.150414, 0.162596, 0.170629, 0.179226, 0.183714, 0.179278
#*# 	0.149252, 0.130565, 0.110129, 0.099957, 0.093622, 0.082453, 0.068921, 0.049885, 0.039827, 0.032337, 0.023160, 0.007411, 0.004299, -0.000949, -0.004676, -0.012249, -0.011223, -0.002509, 0.015382, 0.035633, 0.046299, 0.064530, 0.083505, 0.097977, 0.107545, 0.120314, 0.130984, 0.140080, 0.138959, 0.130484
#*# 	0.128495, 0.113353, 0.097045, 0.082911, 0.073610, 0.061926, 0.050695, 0.035621, 0.026603, 0.014202, 0.001251, -0.006152, -0.013720, -0.024526, -0.031163, -0.034724, -0.032786, -0.022921, -0.010912, 0.005400, 0.023758, 0.041437, 0.057004, 0.074544, 0.088474, 0.096559, 0.103562, 0.110878, 0.111249, 0.110370
#*# 	0.112524, 0.101498, 0.086104, 0.067814, 0.059328, 0.050949, 0.036863, 0.017225, 0.004153, -0.007214, -0.008937, -0.020379, -0.032578, -0.042684, -0.050204, -0.055089, -0.053387, -0.044513, -0.033236, -0.014651, 0.001678, 0.015389, 0.034660, 0.052618, 0.061182, 0.067132, 0.076649, 0.083758, 0.083736, 0.081182
#*# 	0.106710, 0.094771, 0.081296, 0.067614, 0.053555, 0.041741, 0.028646, 0.017354, 0.003883, -0.005965, -0.017511, -0.029171, -0.037308, -0.044289, -0.054922, -0.058205, -0.056821, -0.047850, -0.034825, -0.019857, -0.002539, 0.015149, 0.033678, 0.048730, 0.063051, 0.071605, 0.082514, 0.087956, 0.086852, 0.080538
#*# 	0.103278, 0.093786, 0.082989, 0.064013, 0.050448, 0.041964, 0.032204, 0.019763, 0.006088, -0.002300, -0.016826, -0.025758, -0.031537, -0.043429, -0.050423, -0.052712, -0.050080, -0.042657, -0.027205, -0.015455, 0.005200, 0.019362, 0.037136, 0.054221, 0.068794, 0.079993, 0.089941, 0.096446, 0.094747, 0.087520
#*# 	0.103307, 0.092683, 0.079582, 0.065759, 0.054731, 0.046794, 0.037678, 0.025584, 0.015323, 0.004027, -0.005772, -0.015959, -0.023815, -0.034151, -0.041343, -0.038977, -0.036507, -0.029070, -0.018928, -0.000206, 0.019750, 0.035952, 0.054790, 0.072006, 0.085807, 0.102636, 0.110180, 0.114596, 0.116286, 0.111736
#*# 	0.115594, 0.097344, 0.083949, 0.070649, 0.066749, 0.060578, 0.049503, 0.040968, 0.027370, 0.018727, 0.008231, -0.002290, -0.011436, -0.018385, -0.023893, -0.026729, -0.023994, -0.012260, -0.000807, 0.020301, 0.032255, 0.053448, 0.071528, 0.089434, 0.105648, 0.116132, 0.126362, 0.132894, 0.134086, 0.130799
#*# 	0.100418, 0.091460, 0.082222, 0.072444, 0.061700, 0.059839, 0.051992, 0.044714, 0.033348, 0.022281, 0.017410, 0.005364, -0.002744, -0.009887, -0.014315, -0.016561, -0.009738, -0.001283, 0.015596, 0.034723, 0.050858, 0.070687, 0.092204, 0.111019, 0.128112, 0.139830, 0.150589, 0.158456, 0.160248, 0.159210
#*# 	0.107034, 0.097002, 0.086509, 0.075920, 0.068486, 0.066868, 0.062118, 0.052974, 0.039060, 0.033321, 0.028560, 0.018483, 0.009791, 0.004916, -0.002679, -0.003440, 0.002287, 0.013505, 0.031257, 0.046460, 0.066028, 0.085231, 0.108460, 0.128497, 0.144846, 0.156453, 0.165586, 0.174432, 0.177118, 0.176720
#*# 	0.113981, 0.108301, 0.099016, 0.087533, 0.079851, 0.074526, 0.068306, 0.058618, 0.050387, 0.041564, 0.032919, 0.028346, 0.024125, 0.013965, 0.006229, 0.008710, 0.010684, 0.023722, 0.038941, 0.055990, 0.076936, 0.095915, 0.116983, 0.138198, 0.154020, 0.162032, 0.176645, 0.184333, 0.191333, 0.187196
#*# 	0.112836, 0.105006, 0.098849, 0.083742, 0.078855, 0.072856, 0.064787, 0.058015, 0.047315, 0.042193, 0.038647, 0.030963, 0.024068, 0.017699, 0.011667, 0.013339, 0.016816, 0.028906, 0.042007, 0.061827, 0.080617, 0.102351, 0.120588, 0.143573, 0.156875, 0.171595, 0.184540, 0.191907, 0.196259, 0.193886
#*# 	0.102900, 0.096723, 0.088042, 0.079624, 0.067840, 0.064527, 0.057309, 0.050574, 0.042331, 0.038275, 0.027809, 0.019431, 0.016549, 0.012245, 0.004568, 0.003823, 0.010411, 0.018512, 0.035721, 0.053142, 0.071888, 0.090315, 0.112045, 0.130536, 0.146739, 0.158329, 0.173328, 0.181506, 0.189093, 0.187520
#*# 	0.104629, 0.096928, 0.082572, 0.074841, 0.065199, 0.065172, 0.054481, 0.047061, 0.038631, 0.031071, 0.027611, 0.019611, 0.011209, 0.003421, 0.000992, -0.001789, 0.004152, 0.013629, 0.029346, 0.044031, 0.063172, 0.079367, 0.102175, 0.120006, 0.137831, 0.148910, 0.161143, 0.171180, 0.171305, 0.169252
#*# 	0.097977, 0.090598, 0.082613, 0.071000, 0.064945, 0.060500, 0.053100, 0.043104, 0.037480, 0.029526, 0.021644, 0.017706, 0.008387, 0.001331, -0.001137, -0.001206, 0.001112, 0.009591, 0.021844, 0.039981, 0.057548, 0.077411, 0.096895, 0.116214, 0.133168, 0.147615, 0.157699, 0.166688, 0.171280, 0.168251
#*# 	0.091032, 0.086316, 0.075396, 0.066159, 0.057416, 0.055587, 0.049059, 0.037706, 0.029496, 0.026716, 0.013884, 0.010797, 0.003281, -0.002658, -0.007244, -0.005794, -0.004759, 0.005813, 0.018996, 0.035210, 0.053097, 0.072304, 0.091640, 0.111738, 0.125839, 0.138249, 0.152141, 0.161030, 0.165848, 0.164382
#*# 	0.081445, 0.076785, 0.067939, 0.056730, 0.050244, 0.047806, 0.043125, 0.034220, 0.022069, 0.016907, 0.007663, 0.004670, -0.001058, -0.005163, -0.012462, -0.010891, -0.006596, 0.001278, 0.016144, 0.034737, 0.050172, 0.072070, 0.091307, 0.111631, 0.128251, 0.140426, 0.152230, 0.164380, 0.172272, 0.170573
#*# 	0.082874, 0.075013, 0.067191, 0.057569, 0.048215, 0.042955, 0.036980, 0.028823, 0.020544, 0.012887, 0.004385, -0.001533, -0.007181, -0.015909, -0.019736, -0.020105, -0.018028, -0.006375, 0.007817, 0.025896, 0.042018, 0.060915, 0.080796, 0.099773, 0.115498, 0.130561, 0.141681, 0.152721, 0.155998, 0.154523
#*# 	0.087242, 0.074975, 0.066539, 0.056804, 0.045015, 0.042122, 0.034385, 0.025099, 0.018071, 0.011281, 0.002998, -0.004242, -0.012657, -0.022150, -0.025350, -0.027035, -0.024203, -0.015257, 0.001135, 0.017887, 0.036159, 0.052955, 0.072605, 0.088488, 0.106485, 0.119097, 0.132566, 0.143372, 0.149376, 0.150103
#*# 	0.078372, 0.068840, 0.063304, 0.051134, 0.041236, 0.038142, 0.031350, 0.022933, 0.014219, 0.006595, -0.000311, -0.009284, -0.016570, -0.021270, -0.027299, -0.026925, -0.023876, -0.013921, 0.002977, 0.017100, 0.035449, 0.053119, 0.072618, 0.093120, 0.110226, 0.124564, 0.137706, 0.146038, 0.150596, 0.152223
#*# 	0.078371, 0.069956, 0.059362, 0.050366, 0.039048, 0.035379, 0.027689, 0.018215, 0.007556, 0.004009, -0.009566, -0.018113, -0.023789, -0.031549, -0.035437, -0.036620, -0.033116, -0.025195, -0.010259, 0.007453, 0.023401, 0.042744, 0.060684, 0.079662, 0.098180, 0.111951, 0.125684, 0.136207, 0.141341, 0.140523
#*# 	0.074674, 0.066448, 0.058754, 0.049419, 0.038446, 0.031710, 0.025484, 0.015677, 0.006042, -0.003554, -0.010627, -0.018190, -0.023699, -0.030201, -0.036021, -0.039349, -0.035237, -0.024762, -0.009704, 0.008007, 0.024936, 0.041761, 0.062211, 0.082222, 0.099680, 0.115296, 0.127694, 0.137880, 0.143998, 0.144213
#*# 	0.075798, 0.066260, 0.059038, 0.048996, 0.041124, 0.034241, 0.027504, 0.016279, 0.006231, -0.000336, -0.008397, -0.010760, -0.016217, -0.022733, -0.032862, -0.030849, -0.029091, -0.015316, 0.001132, 0.018919, 0.039024, 0.056875, 0.076311, 0.096020, 0.114986, 0.132614, 0.146409, 0.159096, 0.167509, 0.172112
#*# 	0.077111, 0.068653, 0.064117, 0.050664, 0.041861, 0.034687, 0.026139, 0.016041, 0.009435, -0.000913, -0.009088, -0.016509, -0.022438, -0.028684, -0.035451, -0.035198, -0.031127, -0.021909, -0.004071, 0.014017, 0.032184, 0.052000, 0.069180, 0.090358, 0.109659, 0.125378, 0.140459, 0.150950, 0.158551, 0.159894
#*# 	0.078712, 0.070425, 0.061875, 0.052623, 0.040596, 0.038192, 0.026658, 0.016807, 0.006185, -0.005499, -0.012409, -0.018438, -0.023130, -0.029677, -0.037511, -0.042214, -0.036354, -0.026297, -0.010305, 0.007658, 0.030787, 0.045245, 0.070224, 0.085214, 0.104262, 0.120753, 0.136685, 0.150163, 0.159188, 0.162575
#*# 	0.083729, 0.077167, 0.062725, 0.052642, 0.045182, 0.037773, 0.028248, 0.017673, 0.006223, -0.001727, -0.011690, -0.019290, -0.026317, -0.032527, -0.039089, -0.041773, -0.036917, -0.028183, -0.011582, 0.007205, 0.025524, 0.043062, 0.064158, 0.084862, 0.103064, 0.119971, 0.131552, 0.147981, 0.155737, 0.156978
#*# 	0.089504, 0.080050, 0.072085, 0.059435, 0.049415, 0.041573, 0.031704, 0.020537, 0.009229, 0.002624, -0.007177, -0.014288, -0.023112, -0.027561, -0.036203, -0.036038, -0.033655, -0.021212, -0.005710, 0.012729, 0.028807, 0.051862, 0.069389, 0.091093, 0.109132, 0.125294, 0.142173, 0.153827, 0.165832, 0.171746
#*# 	0.098395, 0.086935, 0.077155, 0.065204, 0.055824, 0.048859, 0.038510, 0.029491, 0.021212, 0.013523, 0.005207, -0.002967, -0.007210, -0.014708, -0.020232, -0.018355, -0.014474, -0.002949, 0.012882, 0.034011, 0.053905, 0.071092, 0.095737, 0.116635, 0.134104, 0.154027, 0.167672, 0.183186, 0.195868, 0.200981
#*# 	0.095820, 0.083865, 0.070165, 0.063227, 0.053501, 0.048574, 0.038268, 0.028758, 0.019310, 0.008481, 0.000161, -0.006907, -0.004197, -0.012516, -0.019668, -0.021164, -0.015058, -0.005109, 0.015117, 0.032280, 0.055359, 0.072818, 0.095352, 0.117267, 0.136891, 0.155117, 0.170751, 0.187095, 0.199344, 0.209946
#*# 	0.098106, 0.085762, 0.072932, 0.065059, 0.054986, 0.047588, 0.038932, 0.031007, 0.020298, 0.014608, 0.009644, 0.003073, -0.005449, -0.008637, -0.015393, -0.015773, -0.009526, 0.002293, 0.020346, 0.041284, 0.061127, 0.084521, 0.104904, 0.127961, 0.147558, 0.165550, 0.186325, 0.201572, 0.216486, 0.225778
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
