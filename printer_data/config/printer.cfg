;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01225
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 220
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 4250
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.4743296059104494,
#*# 	1.8223325033784241,
#*# 	0.7864523960245619,
#*# 	0.11907224163864813,
#*# 	0.33568975158409037,
#*# 	1.199123187163946,
#*# 	-0.22195753078260652,
#*# 	-1.3713505505473869,
#*# 	0.2757985948453994,
#*# 	0.682464273273622
#*# model_domain = 3.1549408902798945e-07,3.29169949814324e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 18.782749
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.021011, 0.015001, 0.013166, 0.006972, 0.001391, 0.002271, 0.001392, -0.004848, -0.011387, -0.014959, -0.017558, -0.023177, -0.028293, -0.033263, -0.040468, -0.046179, -0.045253, -0.036864, -0.027736, -0.012605, -0.001979, 0.000712, 0.007487, 0.014689, 0.016116, 0.015687, 0.006008, -0.008804, -0.021343, -0.041179
#*# 	  0.008565, 0.002194, -0.003933, -0.006995, -0.009958, -0.010449, -0.015712, -0.023133, -0.029018, -0.032632, -0.039800, -0.047364, -0.052040, -0.059204, -0.066550, -0.071178, -0.070250, -0.065244, -0.057713, -0.049000, -0.038749, -0.029365, -0.025101, -0.019262, -0.016277, -0.022067, -0.031150, -0.039422, -0.056073, -0.076372
#*# 	  -0.003158, -0.008795, -0.015095, -0.020372, -0.020048, -0.024285, -0.031997, -0.041095, -0.044897, -0.050449, -0.053050, -0.061599, -0.070384, -0.078768, -0.087386, -0.091521, -0.092099, -0.086811, -0.080672, -0.078230, -0.067466, -0.060641, -0.053316, -0.046392, -0.030858, -0.040444, -0.054056, -0.064533, -0.080815, -0.099429
#*# 	  -0.014193, -0.019708, -0.025279, -0.030593, -0.024688, -0.026904, -0.033570, -0.050080, -0.056370, -0.063885, -0.071544, -0.072729, -0.087727, -0.100326, -0.113542, -0.110947, -0.113165, -0.109278, -0.098188, -0.093022, -0.082514, -0.074769, -0.068449, -0.069902, -0.062622, -0.076071, -0.074273, -0.085401, -0.099995, -0.123439
#*# 	  -0.009171, -0.009364, -0.013967, -0.019153, -0.027070, -0.031411, -0.036791, -0.045350, -0.053419, -0.060232, -0.068503, -0.077215, -0.087343, -0.094911, -0.103335, -0.109057, -0.108708, -0.107099, -0.100581, -0.092871, -0.081144, -0.076259, -0.066344, -0.058017, -0.058937, -0.061881, -0.065975, -0.075872, -0.091070, -0.113415
#*# 	  -0.002100, -0.004520, -0.006895, -0.014062, -0.020058, -0.024499, -0.029483, -0.035113, -0.044632, -0.052304, -0.059468, -0.067985, -0.079611, -0.084899, -0.093137, -0.099529, -0.100642, -0.096222, -0.088491, -0.078230, -0.068144, -0.060091, -0.053287, -0.043885, -0.041775, -0.043140, -0.046374, -0.055053, -0.072382, -0.093987
#*# 	  0.017120, 0.015925, 0.011465, 0.006726, 0.001448, -0.002206, -0.007103, -0.013827, -0.022683, -0.029285, -0.035261, -0.046361, -0.051902, -0.060266, -0.069941, -0.075573, -0.075766, -0.072590, -0.064899, -0.052940, -0.042468, -0.033941, -0.025878, -0.017437, -0.012616, -0.016073, -0.016521, -0.025424, -0.038520, -0.056254
#*# 	  0.023127, 0.022655, 0.020761, 0.015463, 0.014708, 0.012465, 0.006001, -0.003293, -0.009091, -0.010630, -0.019425, -0.027380, -0.030308, -0.038242, -0.049648, -0.053044, -0.052730, -0.048373, -0.036169, -0.027188, -0.013932, -0.004204, 0.004690, 0.013165, 0.018823, 0.020362, 0.017127, 0.012211, -0.000558, -0.021191
#*# 	  0.034842, 0.032260, 0.031170, 0.026779, 0.024454, 0.023208, 0.020875, 0.016812, 0.009675, 0.002449, -0.003403, -0.009682, -0.014004, -0.022206, -0.030791, -0.033516, -0.035291, -0.028804, -0.018026, -0.006185, 0.007167, 0.017021, 0.026487, 0.036169, 0.042552, 0.044021, 0.042894, 0.037047, 0.028819, 0.012156
#*# 	  0.049751, 0.050065, 0.047126, 0.044794, 0.037318, 0.038783, 0.036771, 0.032956, 0.026074, 0.021607, 0.015185, 0.007758, 0.002058, -0.002993, -0.012336, -0.015941, -0.013927, -0.008071, 0.000121, 0.013627, 0.027685, 0.034406, 0.050865, 0.063968, 0.069269, 0.067690, 0.068369, 0.062001, 0.048751, 0.035613
#*# 	  0.061617, 0.061998, 0.060401, 0.055358, 0.053399, 0.050622, 0.048447, 0.044519, 0.038084, 0.030727, 0.029167, 0.023078, 0.013427, 0.008286, 0.003491, -0.002031, 0.000044, 0.006201, 0.016869, 0.029024, 0.044250, 0.053407, 0.066693, 0.078335, 0.085213, 0.089831, 0.091996, 0.083782, 0.067114, 0.059967
#*# 	  0.067201, 0.066339, 0.066166, 0.062739, 0.059375, 0.057151, 0.053751, 0.048970, 0.042733, 0.038556, 0.035066, 0.028683, 0.021644, 0.016107, 0.009093, 0.004425, 0.005178, 0.012333, 0.021390, 0.032311, 0.047001, 0.058760, 0.069837, 0.086191, 0.089386, 0.090340, 0.089865, 0.086763, 0.079077, 0.064992
#*# 	  0.064650, 0.064731, 0.062840, 0.057505, 0.053984, 0.050736, 0.048420, 0.043957, 0.036696, 0.034529, 0.028729, 0.022476, 0.015138, 0.013837, 0.005398, 0.001508, -0.002139, 0.004247, 0.010141, 0.019916, 0.037815, 0.052472, 0.064715, 0.072945, 0.079241, 0.079902, 0.081126, 0.079306, 0.068660, 0.055703
#*# 	  0.060339, 0.060828, 0.057156, 0.052920, 0.050214, 0.050670, 0.046884, 0.041483, 0.036191, 0.032082, 0.027775, 0.019974, 0.016327, 0.007776, -0.001286, -0.003067, -0.002758, 0.006118, 0.016622, 0.024140, 0.035702, 0.041159, 0.053412, 0.065982, 0.084041, 0.086991, 0.080010, 0.080618, 0.067628, 0.049804
#*# 	  0.063504, 0.060905, 0.059293, 0.052540, 0.049785, 0.050089, 0.047782, 0.041458, 0.036346, 0.030937, 0.025919, 0.020542, 0.013944, 0.005032, -0.000122, -0.003964, -0.006498, -0.002073, 0.013063, 0.023260, 0.024421, 0.035810, 0.044207, 0.063702, 0.072841, 0.083395, 0.082386, 0.072519, 0.064186, 0.052749
#*# 	  0.050603, 0.050298, 0.048176, 0.045254, 0.041730, 0.042489, 0.040339, 0.035554, 0.031893, 0.026254, 0.022514, 0.017279, 0.010176, 0.005420, -0.001005, -0.003073, -0.004751, 0.001419, 0.009463, 0.021219, 0.038403, 0.051893, 0.053960, 0.069286, 0.069494, 0.072274, 0.074787, 0.089810, 0.078458, 0.060898
#*# 	  0.044433, 0.041381, 0.040248, 0.037698, 0.035802, 0.034363, 0.034428, 0.032123, 0.023647, 0.020263, 0.016163, 0.010865, 0.002962, -0.001264, -0.008145, -0.019204, -0.011186, -0.006177, 0.001654, 0.014039, 0.030361, 0.043488, 0.057751, 0.063545, 0.059711, 0.062224, 0.063463, 0.063671, 0.056281, 0.055780
#*# 	  0.040027, 0.040997, 0.038489, 0.035628, 0.031041, 0.032433, 0.029135, 0.023726, 0.019141, 0.014301, 0.008255, 0.003837, -0.002610, -0.010342, -0.016602, -0.021225, -0.021987, -0.019633, -0.007230, 0.002932, 0.017499, 0.029389, 0.037268, 0.049615, 0.056012, 0.065222, 0.070932, 0.053631, 0.046267, 0.035897
#*# 	  0.037368, 0.035835, 0.034935, 0.031129, 0.028672, 0.029768, 0.026245, 0.019614, 0.013969, 0.008811, 0.005473, -0.001751, -0.003211, -0.013317, -0.021561, -0.024181, -0.025594, -0.017412, -0.010969, -0.005737, 0.009240, 0.020322, 0.033336, 0.050163, 0.056773, 0.055609, 0.057857, 0.058689, 0.049965, 0.044397
#*# 	  0.031813, 0.031652, 0.029834, 0.027168, 0.023705, 0.022770, 0.020626, 0.015049, 0.009208, 0.003064, -0.002580, -0.011435, -0.016078, -0.023164, -0.030984, -0.037671, -0.036310, -0.033478, -0.022831, -0.009736, 0.003761, 0.007432, 0.017785, 0.029567, 0.030457, 0.040282, 0.042498, 0.042571, 0.033903, 0.023135
#*# 	  0.028202, 0.026692, 0.024869, 0.020194, 0.016589, 0.016273, 0.013293, 0.008648, 0.001184, -0.004904, -0.012512, -0.018679, -0.026466, -0.032740, -0.040626, -0.048061, -0.051681, -0.047249, -0.039188, -0.025029, -0.012693, 0.000720, 0.010741, 0.013849, 0.026176, 0.025623, 0.026793, 0.029468, 0.012134, 0.005946
#*# 	  0.021281, 0.022244, 0.022875, 0.016784, 0.013845, 0.010873, 0.007476, 0.003749, -0.005634, -0.012978, -0.017658, -0.025605, -0.032512, -0.039971, -0.047252, -0.054158, -0.055128, -0.050436, -0.043050, -0.033231, -0.022300, -0.011381, 0.002031, 0.010697, 0.021565, 0.016882, 0.012687, 0.009341, 0.009073, -0.003182
#*# 	  0.015350, 0.015200, 0.012912, 0.011995, 0.007434, 0.004385, 0.002310, -0.000278, -0.013036, -0.019445, -0.024765, -0.032061, -0.040334, -0.045760, -0.059259, -0.064966, -0.064052, -0.057732, -0.048310, -0.037329, -0.022607, -0.019724, -0.010620, 0.000004, 0.006778, 0.008940, 0.011044, 0.003367, -0.006665, -0.006064
#*# 	  0.006639, 0.007224, 0.007615, 0.004927, 0.001100, -0.001177, -0.002664, -0.009116, -0.016785, -0.021711, -0.029270, -0.036340, -0.042394, -0.050424, -0.058592, -0.062872, -0.065039, -0.062349, -0.056512, -0.044803, -0.029757, -0.020778, -0.011897, -0.001914, 0.009481, 0.008445, 0.014122, 0.013406, 0.003939, -0.009454
#*# 	  -0.002038, -0.000529, -0.000996, -0.006353, -0.005823, -0.008701, -0.012910, -0.020090, -0.026880, -0.032640, -0.038535, -0.047362, -0.055681, -0.062767, -0.072792, -0.074926, -0.081187, -0.076101, -0.068759, -0.063530, -0.047810, -0.036169, -0.029056, -0.016277, -0.010119, -0.011532, -0.015599, -0.008381, -0.017608, -0.029036
#*# 	  -0.005455, -0.002715, -0.005237, -0.006419, -0.008960, -0.009186, -0.012068, -0.018803, -0.025944, -0.031996, -0.037306, -0.046656, -0.052096, -0.058314, -0.069761, -0.074586, -0.076427, -0.072269, -0.064917, -0.053356, -0.040922, -0.032965, -0.023534, -0.011803, -0.004612, -0.002654, -0.000327, -0.006253, -0.016608, -0.021069
#*# 	  -0.008083, -0.009458, -0.008471, -0.009823, -0.011446, -0.014770, -0.017913, -0.021950, -0.031372, -0.036533, -0.042979, -0.049590, -0.058032, -0.063931, -0.076363, -0.080483, -0.083267, -0.077464, -0.070765, -0.060821, -0.049383, -0.044147, -0.035399, -0.021265, -0.016204, -0.006928, -0.006835, -0.011066, -0.026242, -0.030925
#*# 	  -0.014267, -0.013632, -0.015607, -0.016229, -0.014938, -0.018842, -0.020152, -0.026170, -0.034145, -0.039564, -0.046712, -0.053355, -0.060517, -0.068480, -0.077993, -0.082648, -0.085663, -0.082697, -0.073486, -0.062907, -0.052847, -0.043789, -0.035999, -0.023869, -0.017580, -0.017612, -0.018022, -0.018403, -0.024758, -0.031457
#*# 	  -0.028114, -0.029513, -0.031144, -0.028831, -0.027303, -0.029669, -0.032038, -0.035792, -0.044891, -0.049981, -0.051771, -0.059753, -0.069727, -0.075589, -0.084476, -0.091834, -0.093877, -0.089894, -0.082034, -0.072757, -0.057078, -0.051950, -0.044466, -0.034435, -0.026862, -0.028110, -0.027046, -0.026305, -0.034053, -0.040323
#*# 	  -0.037171, -0.038241, -0.035517, -0.035125, -0.034226, -0.035004, -0.035643, -0.038836, -0.044351, -0.046982, -0.051006, -0.057503, -0.063933, -0.069113, -0.076970, -0.084640, -0.084651, -0.079103, -0.069375, -0.059415, -0.046621, -0.036413, -0.026889, -0.016930, -0.007866, -0.007570, -0.006022, -0.005323, -0.007443, -0.015567
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
