;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01492
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 250
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.374166106121123,
#*# 	1.8055497020829114,
#*# 	0.7413583058747208,
#*# 	0.2969583793870675,
#*# 	0.48964771586572314,
#*# 	0.6132384606657677,
#*# 	-0.3959039924513543,
#*# 	-0.5949401524302841,
#*# 	0.33968963348466646,
#*# 	0.32998542009163717
#*# model_domain = 3.16552665816649e-07,3.2935678922928883e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 28.519301
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.066326, 0.035992, 0.008685, -0.007884, -0.032167, -0.047552, -0.066508, -0.079463, -0.095229, -0.103590, -0.119508, -0.122502, -0.134780, -0.142242, -0.146728, -0.149224, -0.143059, -0.137473, -0.115857, -0.105870, -0.070712, -0.059844, -0.031581, -0.018528, -0.001700, 0.011363, 0.028541, 0.041552, 0.051567, 0.050312
#*# 	  0.046516, 0.015118, 0.006437, -0.021341, -0.031898, -0.058482, -0.072970, -0.090362, -0.105412, -0.118016, -0.130624, -0.140807, -0.151192, -0.157696, -0.166442, -0.169488, -0.163358, -0.153864, -0.140141, -0.122836, -0.102935, -0.085598, -0.065312, -0.046466, -0.029291, -0.016544, -0.002864, 0.007477, 0.019432, 0.015367
#*# 	  0.027738, -0.003404, -0.020275, -0.046455, -0.057678, -0.075494, -0.092318, -0.104926, -0.128953, -0.134203, -0.152566, -0.156053, -0.170113, -0.173859, -0.187661, -0.191567, -0.188579, -0.189271, -0.166915, -0.147968, -0.143166, -0.112854, -0.093748, -0.074218, -0.044440, -0.047840, -0.019183, -0.040011, 0.000712, -0.018735
#*# 	  0.042976, 0.003122, -0.017174, -0.035779, -0.045204, -0.083906, -0.077898, -0.119167, -0.112610, -0.137659, -0.150351, -0.162349, -0.182757, -0.181299, -0.189550, -0.183807, -0.188274, -0.181257, -0.168570, -0.152361, -0.133283, -0.111456, -0.098833, -0.073316, -0.062881, -0.047729, -0.035236, -0.027466, -0.018689, -0.019775
#*# 	  0.028386, 0.014821, -0.011464, -0.024826, -0.049607, -0.063659, -0.082510, -0.096261, -0.113335, -0.125526, -0.138896, -0.149492, -0.161909, -0.168779, -0.178470, -0.186542, -0.179703, -0.177308, -0.158519, -0.147937, -0.113580, -0.111574, -0.076355, -0.074404, -0.039576, -0.047052, -0.017027, -0.024756, 0.002147, -0.016409
#*# 	  0.036415, 0.012382, -0.002830, -0.026889, -0.037666, -0.063108, -0.066537, -0.094511, -0.097316, -0.122583, -0.120246, -0.147505, -0.142888, -0.166285, -0.158151, -0.177565, -0.158995, -0.160691, -0.142771, -0.129607, -0.105913, -0.088036, -0.068528, -0.046929, -0.030944, -0.016422, -0.002557, 0.007953, 0.012328, 0.011600
#*# 	  0.040514, 0.021556, 0.005723, -0.010655, -0.027277, -0.042743, -0.055479, -0.069795, -0.084149, -0.094738, -0.108342, -0.116071, -0.131708, -0.135122, -0.145741, -0.145874, -0.142739, -0.134240, -0.119853, -0.100099, -0.079693, -0.062363, -0.041488, -0.023593, -0.001825, 0.007391, 0.024605, 0.030178, 0.046400, 0.037427
#*# 	  0.062985, 0.042610, 0.027934, 0.012045, -0.003054, -0.018183, -0.027838, -0.041013, -0.054927, -0.069546, -0.080158, -0.091467, -0.100307, -0.107609, -0.115102, -0.117526, -0.107251, -0.101832, -0.088047, -0.069348, -0.049619, -0.031625, -0.011009, 0.011643, 0.029410, 0.044111, 0.058473, 0.070157, 0.076221, 0.072625
#*# 	  0.077736, 0.060568, 0.045631, 0.030121, 0.016612, 0.002594, -0.005529, -0.019318, -0.033851, -0.046109, -0.058219, -0.068934, -0.077508, -0.086562, -0.092869, -0.095185, -0.090232, -0.080063, -0.064691, -0.044667, -0.027055, -0.007769, 0.013024, 0.035454, 0.054448, 0.068364, 0.080440, 0.093078, 0.097612, 0.099044
#*# 	  0.089702, 0.072220, 0.059473, 0.039709, 0.031654, 0.015118, 0.009967, -0.008143, -0.015946, -0.027546, -0.029950, -0.047460, -0.051444, -0.062495, -0.063390, -0.070708, -0.065728, -0.053127, -0.037770, -0.018653, 0.001195, 0.021969, 0.042869, 0.066044, 0.083421, 0.098261, 0.112528, 0.125216, 0.129788, 0.129819
#*# 	  0.098673, 0.085233, 0.071143, 0.059358, 0.045328, 0.032364, 0.023827, 0.009822, -0.000660, -0.013888, -0.020228, -0.030708, -0.032460, -0.041714, -0.043993, -0.053177, -0.041095, -0.033002, -0.018134, 0.003920, 0.022603, 0.044139, 0.064905, 0.090310, 0.108222, 0.123545, 0.136498, 0.150360, 0.156381, 0.159977
#*# 	  0.107255, 0.097339, 0.084201, 0.072297, 0.052571, 0.045587, 0.035268, 0.023281, 0.012994, 0.003616, -0.004575, -0.012246, -0.021287, -0.031392, -0.029723, -0.038686, -0.029871, -0.019280, -0.003899, 0.015369, 0.036461, 0.059114, 0.078111, 0.102703, 0.115607, 0.140509, 0.143168, 0.173013, 0.160702, 0.169970
#*# 	  0.105088, 0.091999, 0.081693, 0.067543, 0.057405, 0.045954, 0.036479, 0.025080, 0.011022, 0.007411, -0.006661, -0.007552, -0.018994, -0.020591, -0.031478, -0.026724, -0.027075, -0.009761, 0.005597, 0.025248, 0.046183, 0.066910, 0.089779, 0.112492, 0.131934, 0.147132, 0.160960, 0.177441, 0.184466, 0.189558
#*# 	  0.103758, 0.108130, 0.079825, 0.084485, 0.054810, 0.061410, 0.037675, 0.039868, 0.015535, 0.020617, 0.001135, 0.003559, -0.012961, -0.015078, -0.020357, -0.020244, -0.014241, -0.005200, 0.010229, 0.029110, 0.047947, 0.072747, 0.089313, 0.115265, 0.130163, 0.151334, 0.159809, 0.175935, 0.182801, 0.190095
#*# 	  0.122280, 0.109396, 0.096933, 0.083535, 0.073518, 0.063686, 0.054794, 0.043831, 0.032007, 0.022433, 0.008897, 0.007772, -0.006728, -0.006413, -0.020850, -0.012921, -0.015349, -0.000561, 0.009129, 0.032366, 0.051344, 0.070714, 0.093316, 0.114530, 0.131858, 0.148960, 0.160602, 0.176171, 0.182989, 0.188158
#*# 	  0.127702, 0.115436, 0.100556, 0.094645, 0.078638, 0.072748, 0.058856, 0.050872, 0.035208, 0.030991, 0.018997, 0.014449, 0.003998, 0.001522, -0.007220, -0.004262, -0.003057, 0.005364, 0.018129, 0.036287, 0.055392, 0.075779, 0.095486, 0.116384, 0.130307, 0.150859, 0.157523, 0.178435, 0.174499, 0.182339
#*# 	  0.129901, 0.114775, 0.106494, 0.093295, 0.084407, 0.071853, 0.062833, 0.050337, 0.039458, 0.030270, 0.021871, 0.014455, 0.006833, 0.000365, -0.004992, -0.007170, -0.002664, 0.006899, 0.020785, 0.038821, 0.058657, 0.077131, 0.101046, 0.118171, 0.138193, 0.151784, 0.166791, 0.175183, 0.188457, 0.187622
#*# 	  0.131042, 0.110837, 0.110788, 0.087904, 0.088238, 0.070359, 0.073696, 0.050629, 0.049876, 0.032264, 0.032571, 0.016135, 0.014834, 0.005090, 0.003370, 0.001941, 0.007949, 0.016813, 0.032175, 0.051264, 0.069376, 0.089732, 0.110211, 0.131211, 0.151997, 0.165712, 0.181315, 0.197014, 0.202936, 0.197443
#*# 	  0.135927, 0.122351, 0.112239, 0.099568, 0.092559, 0.078759, 0.074721, 0.059572, 0.054063, 0.044879, 0.035898, 0.028430, 0.021429, 0.015335, 0.002121, 0.008843, 0.007943, 0.022905, 0.037878, 0.056820, 0.076919, 0.095483, 0.115246, 0.137937, 0.155692, 0.171534, 0.189043, 0.200612, 0.210594, 0.212458
#*# 	  0.151938, 0.129563, 0.119011, 0.108070, 0.097615, 0.088494, 0.080316, 0.070209, 0.059971, 0.052034, 0.042239, 0.034566, 0.023477, 0.027098, 0.013390, 0.018767, 0.020904, 0.030166, 0.046274, 0.063974, 0.083663, 0.099991, 0.124208, 0.141720, 0.167693, 0.175161, 0.201090, 0.202971, 0.225067, 0.218893
#*# 	  0.149396, 0.135555, 0.126082, 0.116925, 0.105353, 0.094562, 0.087151, 0.075896, 0.066721, 0.063058, 0.048388, 0.049720, 0.035583, 0.038302, 0.014522, 0.031364, 0.017178, 0.042093, 0.046756, 0.073772, 0.085268, 0.108596, 0.125551, 0.150217, 0.170565, 0.188695, 0.199670, 0.214359, 0.224195, 0.232502
#*# 	  0.159518, 0.150199, 0.130022, 0.131989, 0.107311, 0.102214, 0.089788, 0.083889, 0.069619, 0.063028, 0.054975, 0.046145, 0.039245, 0.033691, 0.027144, 0.026006, 0.029325, 0.039068, 0.054277, 0.073098, 0.096499, 0.110638, 0.134756, 0.151407, 0.179479, 0.178527, 0.212945, 0.206220, 0.240895, 0.228267
#*# 	  0.166506, 0.153233, 0.141965, 0.136136, 0.120439, 0.112260, 0.099659, 0.093584, 0.071158, 0.072869, 0.051719, 0.057528, 0.037813, 0.044982, 0.022823, 0.036271, 0.024131, 0.047105, 0.055751, 0.078261, 0.094489, 0.114907, 0.133287, 0.155191, 0.174251, 0.192376, 0.204082, 0.220583, 0.228322, 0.230064
#*# 	  0.177901, 0.161698, 0.150798, 0.141249, 0.129149, 0.111564, 0.107557, 0.099207, 0.084153, 0.079003, 0.063668, 0.059487, 0.048367, 0.045845, 0.034747, 0.031895, 0.036485, 0.045246, 0.061733, 0.077220, 0.096222, 0.114834, 0.134654, 0.154920, 0.179907, 0.192346, 0.212447, 0.222141, 0.238519, 0.233104
#*# 	  0.182510, 0.167224, 0.157231, 0.143626, 0.141635, 0.126217, 0.122445, 0.102798, 0.091458, 0.080072, 0.071873, 0.064018, 0.056448, 0.049511, 0.042838, 0.040019, 0.052036, 0.054209, 0.072087, 0.084304, 0.112975, 0.125128, 0.149182, 0.166017, 0.187626, 0.203005, 0.218460, 0.235293, 0.244571, 0.251076
#*# 	  0.198149, 0.188762, 0.172493, 0.162224, 0.146292, 0.145528, 0.126156, 0.122745, 0.102356, 0.102956, 0.084239, 0.081510, 0.069945, 0.067487, 0.062310, 0.061563, 0.065407, 0.075003, 0.090395, 0.110361, 0.131385, 0.149849, 0.169028, 0.187022, 0.211316, 0.221708, 0.243998, 0.252536, 0.271361, 0.276393
#*# 	  0.210605, 0.195157, 0.186114, 0.175821, 0.164158, 0.148857, 0.146030, 0.125116, 0.123416, 0.102437, 0.106188, 0.092356, 0.090181, 0.076865, 0.071029, 0.068424, 0.073509, 0.083925, 0.098090, 0.119067, 0.140880, 0.158303, 0.178789, 0.199777, 0.219604, 0.238974, 0.254172, 0.269911, 0.280391, 0.288016
#*# 	  0.221484, 0.207184, 0.196803, 0.191309, 0.175627, 0.168007, 0.150055, 0.148873, 0.127963, 0.129332, 0.110648, 0.108913, 0.096779, 0.095380, 0.090632, 0.088661, 0.095786, 0.105207, 0.120351, 0.140979, 0.163516, 0.180848, 0.203054, 0.224766, 0.246988, 0.261196, 0.279824, 0.290006, 0.310176, 0.317196
#*# 	  0.225917, 0.214768, 0.199429, 0.195498, 0.182041, 0.167111, 0.163157, 0.146537, 0.140751, 0.127182, 0.130579, 0.110508, 0.116861, 0.096377, 0.105096, 0.092601, 0.106801, 0.112404, 0.130067, 0.150386, 0.170995, 0.189870, 0.211424, 0.235613, 0.254853, 0.271822, 0.288885, 0.307053, 0.320566, 0.329167
#*# 	  0.238698, 0.222719, 0.207180, 0.196586, 0.191387, 0.177676, 0.174488, 0.158766, 0.152377, 0.132793, 0.137285, 0.118594, 0.117589, 0.105094, 0.111680, 0.099388, 0.110721, 0.121101, 0.137698, 0.157549, 0.180508, 0.199126, 0.221984, 0.244066, 0.266614, 0.282064, 0.301134, 0.318065, 0.338972, 0.344898
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
