[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01225
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic
adaptive_margin: 5

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    112, 112, 20

;[adxl345 bed]
;cs_pin: rpi:None

;[adxl345 hotend]
;cs_pin: scanner:PA3
;spi_bus: spi1

;[resonance_tester]
;accel_chip: adxl345 hotend
;probe_points:
;    112, 112, 20

[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 4250
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.4743296059104494,
#*# 	1.8223325033784241,
#*# 	0.7864523960245619,
#*# 	0.11907224163864813,
#*# 	0.33568975158409037,
#*# 	1.199123187163946,
#*# 	-0.22195753078260652,
#*# 	-1.3713505505473869,
#*# 	0.2757985948453994,
#*# 	0.682464273273622
#*# model_domain = 3.1549408902798945e-07,3.29169949814324e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 18.782749
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.008321, -0.011830, -0.017465, -0.022046, -0.032051, -0.031884, -0.036827, -0.039735, -0.046318, -0.050544, -0.055500, -0.058964, -0.058376, -0.061357, -0.066213, -0.065799, -0.061197, -0.054032, -0.035997, -0.023575, -0.010463, 0.005059, 0.015946, 0.029004, 0.033253, 0.037757, 0.037000, 0.031099, 0.034051, 0.032972
#*# 	  0.001334, -0.017318, -0.006500, -0.032527, -0.051202, -0.037651, -0.056689, -0.062386, -0.053356, -0.058887, -0.057032, -0.059549, -0.071929, -0.090213, -0.093160, -0.092874, -0.087687, -0.072220, -0.047968, -0.047735, -0.038700, -0.014924, -0.003135, 0.016951, 0.021344, 0.018954, 0.016138, 0.004498, 0.004477, -0.004010
#*# 	  -0.018553, -0.021657, -0.030070, -0.042498, -0.048433, -0.044726, -0.048542, -0.055044, -0.060770, -0.067513, -0.073805, -0.079999, -0.086982, -0.088289, -0.093282, -0.096139, -0.093544, -0.091210, -0.075302, -0.058469, -0.039257, -0.032902, -0.014021, -0.000258, -0.009613, -0.008136, -0.007404, -0.006644, -0.014230, -0.020099
#*# 	  -0.024686, -0.029253, -0.023419, -0.037343, -0.037383, -0.051855, -0.055577, -0.072125, -0.077914, -0.074938, -0.081991, -0.076243, -0.080992, -0.093879, -0.101553, -0.103160, -0.102920, -0.099017, -0.087617, -0.078373, -0.066910, -0.050094, -0.032424, -0.011307, -0.007728, -0.001826, -0.011374, -0.024819, -0.031369, -0.043126
#*# 	  -0.016752, -0.016538, -0.020738, -0.027106, -0.036044, -0.040289, -0.042732, -0.052937, -0.058296, -0.060214, -0.068970, -0.075213, -0.078274, -0.085168, -0.092153, -0.096222, -0.091580, -0.086976, -0.073845, -0.058673, -0.040085, -0.038002, -0.029649, -0.014630, -0.010828, -0.000161, 0.002350, 0.001554, -0.009173, -0.035963
#*# 	  -0.003986, -0.000017, -0.003648, -0.014273, -0.008130, -0.022228, -0.024347, -0.031830, -0.046559, -0.044005, -0.052029, -0.056461, -0.048574, -0.066691, -0.070357, -0.073366, -0.081786, -0.064550, -0.052726, -0.039870, -0.025857, -0.015508, -0.004824, 0.008196, 0.015836, 0.026585, 0.022520, 0.009521, 0.003992, -0.010424
#*# 	  -0.003403, 0.000041, -0.004029, -0.010000, -0.013711, -0.015281, -0.020037, -0.023470, -0.027777, -0.033057, -0.038951, -0.044153, -0.044923, -0.047378, -0.054969, -0.056050, -0.051891, -0.044175, -0.032064, -0.017694, -0.004506, 0.007785, 0.022815, 0.033219, 0.041312, 0.046106, 0.045515, 0.042225, 0.033322, 0.021068
#*# 	  0.004979, 0.003792, 0.004143, -0.005137, -0.007097, -0.006390, 0.002160, -0.003469, -0.004493, -0.019946, -0.036926, -0.038795, -0.029325, -0.035061, -0.036454, -0.027173, -0.026957, -0.024508, -0.013912, -0.001623, 0.013033, 0.027820, 0.042234, 0.053305, 0.062688, 0.065759, 0.066475, 0.064079, 0.055615, 0.042756
#*# 	  0.015486, 0.015077, 0.009883, 0.011868, 0.006999, 0.009896, 0.007656, 0.006999, 0.001959, -0.001356, -0.006891, -0.009859, -0.011900, -0.015040, -0.017253, -0.019346, -0.017313, -0.006485, 0.008594, 0.020312, 0.033375, 0.048700, 0.059327, 0.074130, 0.083988, 0.092074, 0.087508, 0.087947, 0.074493, 0.060707
#*# 	  0.023467, 0.020806, 0.024522, 0.017265, 0.023763, 0.022744, 0.023168, 0.018925, 0.022896, 0.010510, 0.005617, 0.004988, -0.004032, -0.007289, -0.009243, -0.004768, 0.003525, 0.010507, 0.023663, 0.035973, 0.049676, 0.063728, 0.074488, 0.088096, 0.100965, 0.105127, 0.107452, 0.104895, 0.096297, 0.078274
#*# 	  0.024544, 0.027253, 0.028552, 0.024568, 0.024836, 0.032083, 0.032336, 0.032896, 0.026871, 0.025838, 0.021901, 0.019455, 0.020061, 0.019508, 0.014943, 0.013749, 0.020954, 0.028314, 0.043405, 0.059670, 0.070075, 0.085577, 0.102882, 0.115456, 0.127406, 0.134453, 0.137376, 0.139002, 0.132024, 0.118879
#*# 	  0.031189, 0.033378, 0.041193, 0.034236, 0.038136, 0.046441, 0.043715, 0.033456, 0.035244, 0.034067, 0.029873, 0.028210, 0.027432, 0.023952, 0.021146, 0.019766, 0.023953, 0.035599, 0.047917, 0.061717, 0.076488, 0.086264, 0.104275, 0.118627, 0.130375, 0.137400, 0.138139, 0.139436, 0.136106, 0.124126
#*# 	  0.019293, 0.025443, 0.029600, 0.031409, 0.028634, 0.036071, 0.035709, 0.037475, 0.029785, 0.025244, 0.018624, 0.018486, 0.018799, 0.017034, 0.009156, 0.012945, 0.015249, 0.023227, 0.042100, 0.051334, 0.060785, 0.067313, 0.086804, 0.098919, 0.110373, 0.133179, 0.137504, 0.138815, 0.124413, 0.113508
#*# 	  0.015630, 0.024114, 0.027493, 0.026969, 0.029530, 0.029622, 0.027339, 0.018965, 0.019659, 0.018959, 0.011111, 0.010517, 0.008846, 0.002176, -0.000841, -0.001308, 0.000541, 0.009170, 0.019386, 0.031146, 0.049105, 0.058476, 0.074984, 0.089999, 0.101821, 0.109341, 0.120069, 0.118655, 0.110734, 0.094815
#*# 	  0.007261, 0.013911, 0.015338, 0.017735, 0.016005, 0.020003, 0.022099, 0.026109, 0.020914, 0.011999, 0.007268, 0.005108, 0.005702, 0.003210, -0.000505, -0.008427, -0.004894, 0.002761, 0.019371, 0.045664, 0.061212, 0.069377, 0.080577, 0.090277, 0.105662, 0.124407, 0.121749, 0.131402, 0.120870, 0.100424
#*# 	  0.007334, 0.015006, 0.019277, 0.012610, 0.015882, 0.017390, 0.014361, 0.011711, 0.011239, 0.007393, -0.000408, 0.000400, -0.002548, -0.004514, -0.010139, -0.007670, -0.008417, -0.001358, 0.014370, 0.027804, 0.047203, 0.059237, 0.072561, 0.085058, 0.094269, 0.107220, 0.114795, 0.115499, 0.112252, 0.099173
#*# 	  0.005745, 0.010681, 0.012664, 0.012112, 0.010486, 0.012627, 0.018982, 0.012855, 0.006996, 0.002323, -0.003754, -0.014005, -0.007935, -0.010161, -0.008210, -0.016142, -0.014198, -0.014331, 0.006102, 0.024075, 0.040891, 0.051352, 0.068326, 0.080019, 0.087157, 0.098878, 0.101697, 0.106809, 0.099052, 0.091035
#*# 	  0.008121, 0.008189, 0.012918, 0.009597, 0.008586, 0.008685, 0.010280, 0.006318, -0.001962, -0.003700, -0.010379, -0.013986, -0.018551, -0.018066, -0.023800, -0.023827, -0.024961, -0.017373, -0.003058, 0.012347, 0.029673, 0.039938, 0.056432, 0.071070, 0.082922, 0.090499, 0.085413, 0.083854, 0.083003, 0.086845
#*# 	  0.007338, 0.007418, 0.008788, 0.004791, 0.003452, 0.005084, 0.003649, -0.004750, -0.005575, -0.010810, -0.023079, -0.031556, -0.025910, -0.022071, -0.026880, -0.029417, -0.044672, -0.035590, -0.020493, 0.005376, 0.020909, 0.024477, 0.040403, 0.043615, 0.062000, 0.068128, 0.071009, 0.072211, 0.058738, 0.055852
#*# 	  0.003501, 0.002530, 0.001989, -0.006795, -0.006878, -0.004151, -0.005198, -0.015867, -0.011528, -0.023134, -0.034232, -0.038236, -0.039881, -0.045278, -0.048930, -0.050544, -0.053623, -0.045502, -0.032882, -0.020502, -0.005776, 0.004728, 0.018404, 0.031447, 0.038216, 0.049537, 0.055505, 0.046523, 0.046521, 0.032469
#*# 	  -0.005267, -0.005285, -0.005596, -0.009934, -0.012310, -0.009005, -0.017225, -0.021841, -0.031651, -0.031898, -0.040051, -0.051058, -0.049654, -0.053825, -0.059874, -0.056525, -0.061551, -0.056234, -0.044996, -0.025569, -0.017262, -0.007211, 0.009877, 0.014052, 0.024146, 0.029275, 0.044017, 0.046345, 0.033155, 0.020729
#*# 	  -0.007765, -0.007882, -0.007584, -0.013190, -0.016695, -0.020530, -0.022897, -0.032710, -0.030735, -0.042706, -0.051810, -0.055386, -0.060997, -0.066802, -0.074077, -0.074340, -0.073803, -0.069103, -0.057905, -0.043164, -0.033158, -0.018491, -0.005756, 0.006833, 0.014737, 0.020998, 0.019298, 0.016868, 0.017356, 0.004592
#*# 	  -0.007622, -0.004461, -0.007814, -0.010041, -0.014968, -0.012379, -0.019716, -0.024281, -0.031526, -0.045699, -0.049684, -0.050498, -0.053429, -0.057424, -0.056585, -0.059621, -0.066029, -0.058007, -0.049895, -0.035957, -0.020522, -0.010409, 0.005037, 0.016209, 0.019616, 0.031961, 0.036204, 0.037643, 0.031098, 0.018224
#*# 	  -0.003975, -0.007408, -0.006967, -0.010851, -0.015667, -0.017167, -0.024178, -0.033963, -0.037863, -0.037864, -0.049071, -0.053833, -0.055102, -0.063791, -0.069081, -0.069921, -0.070877, -0.067614, -0.056438, -0.042702, -0.028736, -0.019968, -0.005485, 0.005592, 0.015890, 0.025647, 0.026350, 0.027777, 0.024180, 0.010171
#*# 	  -0.006950, -0.010982, -0.011476, -0.016553, -0.023577, -0.019979, -0.023893, -0.028134, -0.037785, -0.041584, -0.054497, -0.066165, -0.068581, -0.076442, -0.084647, -0.079288, -0.074798, -0.069209, -0.061495, -0.048573, -0.039125, -0.032021, -0.018245, -0.007934, 0.005032, 0.010241, 0.012993, 0.018606, 0.011821, 0.001387
#*# 	  -0.001193, -0.005886, -0.002843, -0.013681, -0.018195, -0.018762, -0.023648, -0.029218, -0.039983, -0.038924, -0.047781, -0.054295, -0.059416, -0.068947, -0.076768, -0.083520, -0.083136, -0.076196, -0.068102, -0.054611, -0.042534, -0.031046, -0.017802, -0.008047, 0.000316, 0.008051, 0.010785, 0.009372, 0.005466, -0.003145
#*# 	  0.003993, -0.000561, -0.003399, -0.012999, -0.014168, -0.015044, -0.027855, -0.030707, -0.035275, -0.036064, -0.049380, -0.058278, -0.066727, -0.078011, -0.087589, -0.090945, -0.090268, -0.078521, -0.069176, -0.060441, -0.046260, -0.037635, -0.030531, -0.018323, -0.007088, -0.005228, 0.001689, 0.002864, -0.004511, -0.015521
#*# 	  -0.000300, -0.008145, -0.012231, -0.020871, -0.023851, -0.022277, -0.026277, -0.034539, -0.046350, -0.052268, -0.058607, -0.068613, -0.076316, -0.083189, -0.088467, -0.095466, -0.096728, -0.092985, -0.081273, -0.069906, -0.061618, -0.048420, -0.036028, -0.026075, -0.019836, -0.014024, -0.014340, -0.013374, -0.014258, -0.021649
#*# 	  -0.012286, -0.020820, -0.025699, -0.031373, -0.034000, -0.035926, -0.043878, -0.048330, -0.057782, -0.063180, -0.071077, -0.081801, -0.089516, -0.093942, -0.102358, -0.102508, -0.105447, -0.100700, -0.092172, -0.086443, -0.069107, -0.062608, -0.050225, -0.037027, -0.030272, -0.027546, -0.023715, -0.025502, -0.025366, -0.033526
#*# 	  -0.022827, -0.025194, -0.029480, -0.038530, -0.044072, -0.045694, -0.049001, -0.056967, -0.063273, -0.071912, -0.080217, -0.092181, -0.092889, -0.101255, -0.109498, -0.114869, -0.120723, -0.112457, -0.101799, -0.090822, -0.080686, -0.068186, -0.055164, -0.045692, -0.036035, -0.030594, -0.030310, -0.023583, -0.026637, -0.031860
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
