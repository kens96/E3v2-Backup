;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.02059
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 5000
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.3916889371658787,
#*# 	1.8307830272806047,
#*# 	0.7396177182857652,
#*# 	0.3281756181118155,
#*# 	0.6075657980954182,
#*# 	0.4036643853866788,
#*# 	-0.6329817966384356,
#*# 	-0.302747821828245,
#*# 	0.44359129962667126,
#*# 	0.19096664171892128
#*# model_domain = 3.1718999427372645e-07,3.2932430273611936e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 20.689650
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.267378, 0.242514, 0.221768, 0.200868, 0.177633, 0.161696, 0.143911, 0.126030, 0.105579, 0.089515, 0.073850, 0.059615, 0.046753, 0.030749, 0.020720, 0.010804, 0.009598, 0.011867, 0.020280, 0.029917, 0.038026, 0.051030, 0.061896, 0.074711, 0.082263, 0.086499, 0.090231, 0.092817, 0.089392, 0.080669
#*# 	0.244907, 0.208188, 0.184848, 0.163257, 0.162771, 0.146739, 0.122142, 0.100672, 0.083596, 0.058849, 0.044505, 0.033593, 0.025590, 0.006182, -0.007200, -0.017777, -0.020009, -0.018134, -0.012127, -0.000981, 0.009691, 0.020057, 0.030847, 0.041221, 0.046090, 0.050064, 0.053042, 0.052405, 0.049016, 0.038556
#*# 	0.216074, 0.193717, 0.171759, 0.151889, 0.132714, 0.115236, 0.094512, 0.075777, 0.055838, 0.038058, 0.022370, 0.005720, -0.008498, -0.024375, -0.039542, -0.048294, -0.054692, -0.051429, -0.047014, -0.034904, -0.026412, -0.019360, -0.007073, 0.003722, 0.008517, 0.010914, 0.010414, 0.011972, 0.006510, -0.004620
#*# 	0.210817, 0.187083, 0.154953, 0.139276, 0.116155, 0.103287, 0.091547, 0.063957, 0.044660, 0.027366, 0.009085, -0.006231, -0.024755, -0.036750, -0.051739, -0.059146, -0.066164, -0.067964, -0.061170, -0.052638, -0.041489, -0.032455, -0.021174, -0.012411, -0.006405, -0.003620, -0.003604, -0.003154, -0.008559, -0.022281
#*# 	0.197618, 0.178393, 0.158059, 0.136771, 0.115827, 0.099865, 0.080731, 0.058186, 0.040454, 0.020285, 0.002673, -0.012593, -0.027453, -0.041217, -0.058381, -0.068749, -0.072743, -0.074235, -0.066990, -0.060096, -0.049439, -0.038919, -0.026819, -0.018857, -0.012542, -0.009155, -0.006480, -0.007766, -0.015020, -0.024892
#*# 	0.195106, 0.175731, 0.156648, 0.136466, 0.117329, 0.099464, 0.075341, 0.059887, 0.040285, 0.029787, 0.013654, -0.005314, -0.021573, -0.039830, -0.051886, -0.059748, -0.064159, -0.063244, -0.056475, -0.049341, -0.035822, -0.027960, -0.013943, -0.003448, 0.002877, 0.006306, 0.009311, 0.011286, 0.004712, -0.010243
#*# 	0.189281, 0.173230, 0.156001, 0.136720, 0.117069, 0.102268, 0.086065, 0.069216, 0.052672, 0.031680, 0.015648, 0.001440, -0.008892, -0.024505, -0.040628, -0.052406, -0.054054, -0.050965, -0.040902, -0.031759, -0.021322, -0.015407, 0.002038, 0.011985, 0.021456, 0.027111, 0.030346, 0.034879, 0.025844, 0.012628
#*# 	0.199844, 0.184915, 0.169427, 0.145812, 0.123261, 0.112784, 0.100310, 0.088071, 0.069547, 0.048500, 0.029740, 0.015916, -0.000014, -0.009719, -0.021503, -0.032398, -0.037643, -0.034139, -0.025343, -0.015187, -0.006135, 0.004820, 0.020086, 0.030352, 0.039526, 0.049437, 0.051578, 0.049555, 0.040714, 0.031210
#*# 	0.195578, 0.180295, 0.160661, 0.147570, 0.133943, 0.120323, 0.105458, 0.088550, 0.068364, 0.058038, 0.047233, 0.032981, 0.013519, -0.001342, -0.011554, -0.018513, -0.019609, -0.016870, -0.007759, 0.003407, 0.014337, 0.028483, 0.040662, 0.055965, 0.064922, 0.076211, 0.074672, 0.075996, 0.068918, 0.058123
#*# 	0.198444, 0.182806, 0.169963, 0.156207, 0.141839, 0.130510, 0.112314, 0.096974, 0.078449, 0.068194, 0.051954, 0.037378, 0.026830, 0.011780, 0.001085, -0.006633, -0.009877, -0.003455, 0.004430, 0.014515, 0.027825, 0.043224, 0.058291, 0.071740, 0.079029, 0.082589, 0.089413, 0.096344, 0.094532, 0.075558
#*# 	0.204168, 0.188369, 0.174915, 0.159418, 0.142617, 0.129087, 0.121942, 0.101711, 0.088207, 0.072086, 0.059843, 0.046539, 0.035152, 0.022009, 0.010546, 0.003263, 0.001313, 0.005288, 0.015163, 0.020694, 0.040026, 0.057128, 0.069897, 0.082198, 0.093266, 0.092319, 0.104094, 0.107504, 0.111165, 0.095737
#*# 	0.208335, 0.191988, 0.178004, 0.161757, 0.145607, 0.132665, 0.116660, 0.104115, 0.090665, 0.076867, 0.064479, 0.053055, 0.038663, 0.028002, 0.014935, 0.009338, 0.003601, 0.011662, 0.021127, 0.031195, 0.046086, 0.052321, 0.068058, 0.080182, 0.104366, 0.112790, 0.116911, 0.103308, 0.100113, 0.096227
#*# 	0.197150, 0.183988, 0.168676, 0.153203, 0.136910, 0.126032, 0.112986, 0.092472, 0.082234, 0.075295, 0.056254, 0.045145, 0.033402, 0.013969, 0.003266, 0.002572, 0.007397, 0.009519, 0.005785, 0.015726, 0.034027, 0.048815, 0.069197, 0.075167, 0.080538, 0.084552, 0.099093, 0.103662, 0.110847, 0.090252
#*# 	0.203172, 0.183885, 0.165166, 0.150860, 0.130687, 0.123825, 0.112760, 0.091231, 0.079680, 0.066496, 0.052849, 0.039824, 0.029665, 0.015445, 0.005460, -0.001636, -0.004460, -0.004466, 0.002388, 0.014552, 0.026944, 0.043000, 0.053066, 0.061378, 0.067356, 0.083288, 0.088873, 0.090899, 0.089706, 0.077421
#*# 	0.193206, 0.177104, 0.168070, 0.147432, 0.132052, 0.121391, 0.108653, 0.090085, 0.077314, 0.063493, 0.050377, 0.045142, 0.025314, 0.006707, 0.001691, -0.003009, -0.001013, 0.003318, -0.007090, 0.003666, 0.022171, 0.042748, 0.056421, 0.054265, 0.063206, 0.069507, 0.085544, 0.098640, 0.086469, 0.078029
#*# 	0.185025, 0.169238, 0.155312, 0.139238, 0.124853, 0.115844, 0.100886, 0.085172, 0.072812, 0.058627, 0.045466, 0.032343, 0.021774, 0.011336, 0.000131, -0.005129, -0.008893, -0.006153, 0.000546, 0.014004, 0.024258, 0.034922, 0.053020, 0.067747, 0.076014, 0.083484, 0.087744, 0.093873, 0.093461, 0.083799
#*# 	0.176531, 0.164770, 0.148526, 0.138618, 0.119383, 0.109343, 0.095912, 0.080255, 0.065602, 0.051552, 0.037866, 0.026587, 0.022831, 0.010850, -0.013562, -0.020722, -0.011371, -0.010357, -0.007124, -0.003435, 0.008683, 0.031023, 0.041475, 0.054634, 0.066844, 0.073316, 0.080332, 0.086434, 0.083848, 0.066594
#*# 	0.177771, 0.163634, 0.145603, 0.130006, 0.117217, 0.106199, 0.093097, 0.076707, 0.059757, 0.048196, 0.034784, 0.020590, 0.008025, -0.003183, -0.015900, -0.022593, -0.027678, -0.026182, -0.015082, -0.003481, 0.007793, 0.020251, 0.039995, 0.052801, 0.056980, 0.055839, 0.070262, 0.085989, 0.082662, 0.060956
#*# 	0.174855, 0.159751, 0.149722, 0.124617, 0.110674, 0.099154, 0.096882, 0.078903, 0.062007, 0.040697, 0.025468, 0.020136, 0.016584, 0.003323, -0.014735, -0.022130, -0.034319, -0.022282, -0.014658, -0.001689, 0.010281, 0.020580, 0.035264, 0.048668, 0.050794, 0.067597, 0.074852, 0.086193, 0.086609, 0.073972
#*# 	0.180031, 0.159766, 0.148376, 0.123438, 0.108599, 0.100460, 0.089856, 0.071568, 0.058856, 0.043067, 0.025594, 0.013161, 0.003300, -0.011908, -0.021651, -0.029723, -0.035430, -0.029756, -0.021694, -0.008327, 0.001413, 0.013429, 0.019368, 0.032317, 0.048691, 0.066774, 0.074403, 0.059409, 0.059373, 0.053802
#*# 	0.171891, 0.155623, 0.140932, 0.126947, 0.109723, 0.092628, 0.078374, 0.069291, 0.059286, 0.044092, 0.030758, 0.017624, -0.008001, -0.021372, -0.032123, -0.032160, -0.036110, -0.027113, -0.024138, -0.013289, -0.003095, 0.017085, 0.030237, 0.035218, 0.048078, 0.046891, 0.053619, 0.060141, 0.068612, 0.068921
#*# 	0.166796, 0.154301, 0.138369, 0.121459, 0.107472, 0.092047, 0.080720, 0.064010, 0.047581, 0.032484, 0.018133, 0.004495, -0.008456, -0.019279, -0.031534, -0.040249, -0.042619, -0.040016, -0.034271, -0.026761, -0.001326, 0.007127, 0.026209, 0.036737, 0.041584, 0.041155, 0.048447, 0.063081, 0.063202, 0.051326
#*# 	0.169893, 0.154255, 0.137943, 0.122541, 0.108629, 0.099077, 0.089780, 0.071309, 0.060508, 0.030403, 0.016942, 0.003547, -0.008201, -0.019801, -0.023838, -0.021917, -0.023125, -0.023226, -0.019105, -0.007962, -0.002926, 0.016803, 0.031828, 0.045661, 0.057854, 0.058854, 0.065650, 0.072524, 0.093074, 0.088140
#*# 	0.170715, 0.155827, 0.140739, 0.129406, 0.110041, 0.095479, 0.082326, 0.062723, 0.051969, 0.036783, 0.019663, 0.007398, -0.003207, -0.017145, -0.028187, -0.037362, -0.040579, -0.035669, -0.029384, -0.016006, -0.001671, 0.013331, 0.027776, 0.041707, 0.049922, 0.062516, 0.077884, 0.076438, 0.076669, 0.070150
#*# 	0.168980, 0.156227, 0.141242, 0.124188, 0.113584, 0.100762, 0.080122, 0.060857, 0.047809, 0.027347, 0.016860, 0.002621, -0.008608, -0.021852, -0.034521, -0.041868, -0.045940, -0.036975, -0.034338, -0.021116, -0.008591, -0.002202, 0.012867, 0.026273, 0.042096, 0.060288, 0.070130, 0.074678, 0.070249, 0.060908
#*# 	0.176733, 0.158520, 0.145670, 0.128304, 0.109083, 0.098185, 0.080044, 0.060516, 0.048082, 0.030575, 0.016011, 0.001984, -0.011008, -0.024097, -0.035077, -0.045065, -0.049086, -0.045123, -0.036798, -0.025099, -0.011328, -0.003139, 0.013362, 0.028686, 0.040510, 0.055596, 0.061465, 0.066949, 0.068349, 0.060184
#*# 	0.186151, 0.170656, 0.152438, 0.136347, 0.115240, 0.103688, 0.089671, 0.078201, 0.059405, 0.049377, 0.035154, 0.012744, -0.000884, -0.015770, -0.020872, -0.027856, -0.031722, -0.028166, -0.022581, -0.005641, 0.007782, 0.025403, 0.037425, 0.050590, 0.065227, 0.073593, 0.082328, 0.092713, 0.097361, 0.095920
#*# 	0.189371, 0.175438, 0.156859, 0.139190, 0.125914, 0.111261, 0.097941, 0.079285, 0.060145, 0.049177, 0.031849, 0.020366, 0.007284, -0.004048, -0.015045, -0.024654, -0.025863, -0.022249, -0.012245, 0.001016, 0.011167, 0.028038, 0.042602, 0.058806, 0.072293, 0.083085, 0.091315, 0.097268, 0.101798, 0.100682
#*# 	0.186707, 0.172545, 0.152609, 0.140537, 0.123909, 0.109181, 0.090394, 0.074992, 0.062807, 0.047329, 0.034032, 0.024330, 0.009659, -0.001378, -0.012912, -0.019840, -0.022075, -0.018031, -0.005775, 0.005572, 0.021664, 0.034475, 0.050659, 0.067021, 0.080200, 0.091362, 0.102220, 0.111413, 0.117974, 0.121310
#*# 	0.195367, 0.175129, 0.157676, 0.136283, 0.123259, 0.104260, 0.094633, 0.073657, 0.060300, 0.050886, 0.037860, 0.025840, 0.011314, -0.001991, -0.012829, -0.019666, -0.019896, -0.015360, -0.005477, 0.010234, 0.023050, 0.037520, 0.054537, 0.070335, 0.083358, 0.095950, 0.108511, 0.119193, 0.127576, 0.127834
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
