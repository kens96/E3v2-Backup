[include .dynamicmacros.cfg]
# Creality "v4.2.7" board
# During "make menuconfig" select 
# ### STM32F103
# ### 28KiB bootloader
# ### serial (on USART1 PA10/PA9) communication
# "Make" top build firmware
# Copy firmware from "out/klipper.bin" to a SD card, turning on the printer with card inserted.
# filename must end in ".bin" and must not match the last filename

#########################################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01204
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 200
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 25, 25
algorithm: bicubic
adaptive_margin: 5

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180

[include shell_command.cfg]

[include mmu/base/*.cfg]

[include mmu/optional/client_macros.cfg]

[include mmu_gate_map_macros.cfg]

[include gcode_macro.cfg]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

[pause_resume]

[dynamicmacros]
configs: dynamic.cfg
interface_workaround: true

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345]
;cs_pin: rpi:None

;[resonance_tester]
;accel_chip: adxl345
;probe_points:
;    112, 112, 20

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20

[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 51.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.4
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.060
#*#
#*# [scanner model default]
#*# model_coef = 1.5051225983378953,
#*# 	1.8195102390006643,
#*# 	0.7021231371548109,
#*# 	0.5179341351214521,
#*# 	0.4514142856553639,
#*# 	-0.08515172425706082,
#*# 	-0.27110137461058453,
#*# 	0.12857188619028087,
#*# 	0.2608578490457167,
#*# 	0.06999231648430079
#*# model_domain = 3.1657411074412126e-07,3.292824091111193e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 23.534723
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.297962, 0.278975, 0.257612, 0.242409, 0.226091, 0.211906, 0.195719, 0.182066, 0.165868, 0.152175, 0.141438, 0.129893, 0.118678, 0.113686, 0.114605, 0.122934, 0.134270, 0.144243, 0.159168, 0.173444, 0.176222, 0.168677, 0.158943, 0.149475, 0.126756
#*# 	  0.265303, 0.242294, 0.221148, 0.206624, 0.190412, 0.173557, 0.156095, 0.141740, 0.123671, 0.108629, 0.094528, 0.080247, 0.067068, 0.059361, 0.058873, 0.064164, 0.074773, 0.084926, 0.098681, 0.111368, 0.114222, 0.105202, 0.092695, 0.077586, 0.055280
#*# 	  0.237824, 0.215240, 0.195091, 0.180584, 0.164186, 0.145152, 0.127736, 0.114162, 0.094004, 0.076515, 0.062451, 0.046452, 0.033197, 0.025133, 0.022210, 0.028610, 0.038437, 0.048595, 0.057894, 0.068063, 0.071405, 0.061127, 0.049046, 0.034282, 0.012241
#*# 	  0.220178, 0.200938, 0.182519, 0.164206, 0.144057, 0.127406, 0.108906, 0.092071, 0.073048, 0.057112, 0.042139, 0.024411, 0.010575, 0.000956, -0.002052, 0.007475, 0.017180, 0.025071, 0.032719, 0.040632, 0.042136, 0.037283, 0.024564, 0.011260, -0.011210
#*# 	  0.200702, 0.182506, 0.165500, 0.147473, 0.130096, 0.114913, 0.100278, 0.082017, 0.062655, 0.046430, 0.032573, 0.015568, 0.003417, -0.002760, -0.006067, 0.000484, 0.011150, 0.022012, 0.030245, 0.037476, 0.040264, 0.035597, 0.028635, 0.015600, -0.007432
#*# 	  0.192688, 0.175009, 0.157425, 0.140934, 0.126852, 0.111660, 0.094695, 0.080048, 0.062255, 0.043418, 0.027689, 0.012989, 0.002004, -0.006725, -0.008325, -0.000337, 0.008235, 0.016980, 0.028104, 0.036863, 0.039313, 0.038938, 0.033710, 0.019231, -0.001850
#*# 	  0.181150, 0.163523, 0.150211, 0.135353, 0.122211, 0.111591, 0.097245, 0.082788, 0.066106, 0.047102, 0.031103, 0.016799, 0.005598, -0.000593, -0.002705, 0.004908, 0.016321, 0.024218, 0.036399, 0.047594, 0.053440, 0.051792, 0.046356, 0.036158, 0.018158
#*# 	  0.185090, 0.166116, 0.151165, 0.138785, 0.126443, 0.114654, 0.102958, 0.085758, 0.069015, 0.051391, 0.034969, 0.018933, 0.007703, 0.002577, 0.001087, 0.005571, 0.015667, 0.026017, 0.037934, 0.048580, 0.054111, 0.054978, 0.047015, 0.038131, 0.020719
#*# 	  0.180366, 0.160103, 0.147584, 0.133787, 0.119708, 0.108068, 0.095671, 0.079611, 0.062055, 0.046389, 0.031800, 0.015021, 0.001621, -0.002006, -0.000355, 0.003056, 0.010973, 0.020850, 0.034591, 0.044178, 0.049702, 0.051077, 0.047890, 0.036434, 0.017612
#*# 	  0.178363, 0.161359, 0.144487, 0.131628, 0.119130, 0.104140, 0.091295, 0.077027, 0.060422, 0.044322, 0.030645, 0.013518, -0.001336, -0.005382, -0.004962, -0.002305, 0.008520, 0.019025, 0.028968, 0.040469, 0.045847, 0.046243, 0.041894, 0.031917, 0.011687
#*# 	  0.167342, 0.151428, 0.136697, 0.123597, 0.110183, 0.096684, 0.079802, 0.065121, 0.051598, 0.036795, 0.022425, 0.007240, -0.004889, -0.011996, -0.012943, -0.006998, 0.002674, 0.014104, 0.022571, 0.032590, 0.038407, 0.039855, 0.036010, 0.026876, 0.009126
#*# 	  0.169246, 0.152352, 0.140000, 0.124905, 0.114291, 0.100135, 0.082089, 0.067221, 0.051702, 0.036299, 0.020367, 0.005493, -0.006233, -0.013530, -0.016177, -0.012237, -0.003982, 0.003015, 0.014915, 0.025426, 0.029395, 0.028862, 0.026614, 0.019451, 0.002255
#*# 	  0.177534, 0.158854, 0.144359, 0.131650, 0.119319, 0.102903, 0.083252, 0.067889, 0.051127, 0.034037, 0.018125, 0.003644, -0.009661, -0.018988, -0.024044, -0.022246, -0.016366, -0.006950, 0.003842, 0.013215, 0.018333, 0.015957, 0.012554, 0.002930, -0.010219
#*# 	  0.172123, 0.156406, 0.138146, 0.126744, 0.115388, 0.099492, 0.082636, 0.065239, 0.046329, 0.030811, 0.016521, 0.002342, -0.009105, -0.019518, -0.024922, -0.021650, -0.014020, -0.004784, 0.004853, 0.013879, 0.016170, 0.016686, 0.013051, 0.005978, -0.008765
#*# 	  0.174147, 0.155498, 0.142731, 0.127215, 0.113070, 0.100674, 0.081775, 0.063458, 0.045712, 0.029611, 0.012867, -0.002379, -0.018178, -0.028504, -0.033972, -0.030897, -0.021693, -0.012914, -0.004645, 0.004193, 0.007074, 0.003735, 0.003121, -0.004992, -0.020025
#*# 	  0.183079, 0.165479, 0.149585, 0.133282, 0.117303, 0.102708, 0.085636, 0.068815, 0.049209, 0.033420, 0.016602, -0.002085, -0.016766, -0.030062, -0.035328, -0.031130, -0.021550, -0.016029, -0.007753, -0.000175, 0.003178, 0.004453, -0.000567, -0.010193, -0.025488
#*# 	  0.188993, 0.169926, 0.154279, 0.135799, 0.119609, 0.105248, 0.088380, 0.069057, 0.049811, 0.033345, 0.015197, -0.002521, -0.019906, -0.032670, -0.038402, -0.035029, -0.027252, -0.022989, -0.016008, -0.008160, -0.004092, -0.005978, -0.009339, -0.016344, -0.031264
#*# 	  0.200653, 0.180938, 0.161301, 0.143308, 0.126940, 0.110758, 0.089869, 0.071705, 0.048815, 0.029646, 0.011539, -0.007143, -0.024182, -0.039058, -0.045595, -0.042728, -0.037624, -0.033200, -0.026037, -0.018979, -0.016075, -0.016357, -0.020672, -0.031238, -0.046454
#*# 	  0.211489, 0.192361, 0.172991, 0.154366, 0.137899, 0.117724, 0.097261, 0.076986, 0.055756, 0.034622, 0.016586, -0.001873, -0.020349, -0.034526, -0.041462, -0.039598, -0.032451, -0.029739, -0.022938, -0.016172, -0.013826, -0.016773, -0.018703, -0.028577, -0.045124
#*# 	  0.217144, 0.196652, 0.177417, 0.160622, 0.143961, 0.124042, 0.101847, 0.083630, 0.060973, 0.039638, 0.026491, 0.005687, -0.015206, -0.026474, -0.031654, -0.029097, -0.022468, -0.019456, -0.010062, -0.002354, 0.000723, 0.001901, -0.002581, -0.012365, -0.028146
#*# 	  0.224461, 0.205965, 0.186957, 0.167325, 0.150221, 0.129031, 0.105459, 0.084815, 0.063474, 0.042849, 0.021897, 0.003918, -0.013152, -0.028838, -0.036894, -0.035231, -0.027951, -0.021958, -0.017591, -0.011318, -0.006572, -0.006893, -0.011155, -0.021242, -0.037642
#*# 	  0.239667, 0.217330, 0.198974, 0.178905, 0.158800, 0.137184, 0.116339, 0.096057, 0.072113, 0.050576, 0.033161, 0.011267, -0.006817, -0.021621, -0.029193, -0.027959, -0.021135, -0.015617, -0.009514, -0.002550, 0.000821, 0.001795, -0.001235, -0.010858, -0.024659
#*# 	  0.253080, 0.230142, 0.210247, 0.188923, 0.166811, 0.146533, 0.126685, 0.104646, 0.080050, 0.058305, 0.038160, 0.017020, -0.002414, -0.015020, -0.024671, -0.023752, -0.016463, -0.011931, -0.006071, 0.001102, 0.004644, 0.003124, 0.000745, -0.007355, -0.019869
#*# 	  0.261985, 0.239203, 0.215561, 0.192880, 0.173171, 0.152249, 0.128150, 0.105768, 0.083368, 0.059145, 0.038133, 0.017651, -0.003490, -0.019767, -0.025685, -0.022871, -0.020040, -0.015757, -0.008836, -0.000653, -0.000060, -0.001577, -0.005264, -0.011696, -0.023505
#*# 	  0.270474, 0.247025, 0.220964, 0.199516, 0.178214, 0.159060, 0.134915, 0.111854, 0.088710, 0.066329, 0.042760, 0.021195, 0.001913, -0.015845, -0.023918, -0.022845, -0.018496, -0.014605, -0.006562, -0.002066, -0.000245, -0.000371, -0.003254, -0.008698, -0.010910
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
