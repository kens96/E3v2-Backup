;[include mainsail.cfg]
#Change log 
#RH 01/09/24 - Re-install of Pi 3+ Merge of previous working configs form previous Pi Install and Nebula Pad


# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.
# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.


#########################################################################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0008001143304146393320-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 17                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.01225
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 112,112
#    set this to the middle of your bed
speed: 220
#    movement speed of toolhead during bed mesh
horizontal_move_z: 3
#    height of scanner during bed mesh scan
mesh_min: 12, 13
#    start point of bed mesh [X, Y]
mesh_max: 213, 203
#    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

#########################################################################################
[mmu_servo purge]
# Pin for the servo.
pin: PB0
minimum_pulse_width: 0.00053
maximum_pulse_width: 0.0023
maximum_servo_angle: 180



[include shell_command.cfg]
;[include mmu/addons/blobifier.cfg]
[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
;[include mmu/optional/mmu_menu.cfg]
[include mmu_gate_map_macros.cfg]
[include gcode_macro.cfg]
[exclude_object]
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
[display_status]
[pause_resume]

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: -12
position_min: -12
position_max: 279
homing_speed: 80

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -6
position_min: -6
;position_max: 225
position_max: 247
homing_speed: 80

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop   #enabled to use bltouch
position_min: -10
position_max: 230
homing_retract_dist: 0

;[filament_switch_sensor filament_sensor]
;switch_pin: PA4
;pause_on_runout: true
;runout_gcode: PAUSE

[extruder]
max_extrude_only_distance: 1000.0
pressure_advance = 0.064
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12   # For Sprite SE Direct Drive
rotation_distance: 26.670  #Changed to support sprite Extruder, this was a calculated
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 301 # increased from default 265

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host

[temperature_sensor mmu]
sensor_type: temperature_mcu
sensor_mcu: mmu

[fan]
 pin: PA0
 
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command


;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345 bed]
;cs_pin: rpi:None

[adxl345 hotend]
cs_pin: scanner:PA3
spi_bus: spi1


[resonance_tester]
accel_chip: adxl345 hotend
probe_points:
    112, 112, 20



[printer]
kinematics: cartesian
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 300
square_corner_velocity: 5.0

[safe_z_home]
home_xy_position:112,110
speed: 220
z_hop: 8
z_hop_speed: 10

;[bltouch]
;sensor_pin: ^PB1
;control_pin: PB0
;x_offset: -48.1
;y_offset: -5.0
;z_offset: 0
;speed: 20
;samples: 1
;stow_on_each_sample = false #high speed for bltouch

[screws_tilt_adjust]
screw1: 27,10  # Original
screw1_name: front left screw
screw2: 197,10  # Original
screw2_name: front right screw
screw3: 197,180  # Original
screw3_name: rear right screw
screw4: 27,180  # Original
screw4_name: rear left screw
horizontal_move_z: 10
speed: 120
screw_thread: CW-M4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 53.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 44.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.087
#*# pid_ki = 3.343
#*# pid_kd = 72.277
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.963
#*# pid_ki = 1.162
#*# pid_kd = 1083.074
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1750
#*# scanner_touch_speed = 2
#*# scanner_touch_z_offset = 0.080
#*#
#*# [scanner model default]
#*# model_coef = 1.3898734489027706,
#*# 	1.7940551954419217,
#*# 	0.7046323543659296,
#*# 	0.3873624771371894,
#*# 	0.5599305548279637,
#*# 	0.35580190293360436,
#*# 	-0.47162533631627046,
#*# 	-0.3141038075145196,
#*# 	0.3672054519017221,
#*# 	0.22791831359684223
#*# model_domain = 3.159801232495154e-07,3.2924052615285917e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 20.451650
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.063312, -0.046455, -0.012759, 0.033793, 0.088734
#*# compensation_start_x = 20.0
#*# compensation_end_x = 200.0
#*# zy_compensations = -0.023366, 0.054400, 0.026471, -0.013257, -0.044248
#*# compensation_start_y = 20.0
#*# compensation_end_y = 200.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.112902, 0.099903, 0.089750, 0.076495, 0.064073, 0.060077, 0.053008, 0.044141, 0.034610, 0.025494, 0.020360, 0.014591, 0.006932, 0.001357, -0.003803, -0.006133, -0.002801, 0.003277, 0.016408, 0.028370, 0.043312, 0.058796, 0.068188, 0.078535, 0.086451, 0.089943, 0.093052, 0.096429, 0.088195, 0.079043
#*# 	  0.095028, 0.087770, 0.075167, 0.070150, 0.052612, 0.047542, 0.031190, 0.028221, 0.017664, 0.011136, 0.011212, -0.015256, -0.019810, -0.017941, -0.024942, -0.029012, -0.019763, -0.027177, -0.016401, 0.004094, 0.017228, 0.029489, 0.048796, 0.053949, 0.056130, 0.062740, 0.064497, 0.069412, 0.064311, 0.047635
#*# 	  0.085203, 0.069970, 0.055564, 0.042257, 0.030483, 0.021181, 0.019563, 0.009124, -0.004366, -0.011899, -0.020708, -0.034689, -0.037131, -0.041482, -0.052703, -0.056910, -0.056632, -0.055415, -0.041612, -0.028698, -0.014379, -0.002784, 0.007860, 0.019711, 0.025970, 0.029614, 0.029207, 0.026877, 0.020767, 0.013491
#*# 	  0.063636, 0.060438, 0.041311, 0.028971, 0.017541, 0.006488, -0.000099, -0.014312, -0.019181, -0.033487, -0.043401, -0.052074, -0.059882, -0.072564, -0.071553, -0.076159, -0.081738, -0.076953, -0.068463, -0.057739, -0.040533, -0.028826, -0.017164, -0.005398, -0.000861, 0.008414, 0.008211, 0.002459, -0.002024, -0.016588
#*# 	  0.065458, 0.057137, 0.044823, 0.033135, 0.017277, 0.008819, -0.000889, -0.011533, -0.022510, -0.034344, -0.042512, -0.050245, -0.061251, -0.070308, -0.078111, -0.085346, -0.083530, -0.076777, -0.067124, -0.055447, -0.043757, -0.030400, -0.018435, -0.007545, 0.001106, 0.004414, 0.006453, 0.003797, -0.001999, -0.017555
#*# 	  0.064389, 0.054771, 0.047252, 0.033658, 0.022411, 0.015383, 0.001817, -0.009472, -0.017089, -0.025651, -0.035923, -0.042739, -0.053883, -0.062640, -0.071210, -0.075841, -0.074271, -0.066377, -0.056269, -0.041837, -0.030993, -0.019332, -0.007282, 0.006159, 0.014187, 0.018841, 0.022734, 0.022042, 0.014210, 0.001766
#*# 	  0.079347, 0.068019, 0.057683, 0.046169, 0.037542, 0.027539, 0.019681, 0.009501, 0.000672, -0.008617, -0.017836, -0.028757, -0.037969, -0.045370, -0.053139, -0.057867, -0.056077, -0.048368, -0.035770, -0.022507, -0.010326, 0.000537, 0.012448, 0.026344, 0.036137, 0.040983, 0.045786, 0.044108, 0.039352, 0.027206
#*# 	  0.071918, 0.070005, 0.068388, 0.056235, 0.041343, 0.030900, 0.024011, 0.022726, 0.016392, 0.009785, 0.002141, -0.017025, -0.027682, -0.030292, -0.036443, -0.039301, -0.038039, -0.031578, -0.016202, -0.004183, 0.009125, 0.023191, 0.035272, 0.048724, 0.060125, 0.067513, 0.070405, 0.070812, 0.064566, 0.056267
#*# 	  0.086984, 0.079115, 0.069496, 0.061103, 0.053628, 0.048043, 0.043591, 0.039255, 0.030905, 0.020998, 0.014224, 0.004889, -0.004322, -0.012349, -0.019842, -0.021976, -0.018939, -0.009537, 0.001346, 0.015764, 0.032415, 0.045076, 0.059468, 0.074850, 0.086169, 0.093862, 0.097594, 0.098285, 0.095205, 0.083893
#*# 	  0.098819, 0.092537, 0.083461, 0.074165, 0.066104, 0.058786, 0.058660, 0.052649, 0.042734, 0.035119, 0.026370, 0.017501, 0.008045, 0.001957, -0.006177, -0.008221, -0.005160, 0.002903, 0.014001, 0.026558, 0.043264, 0.058016, 0.076223, 0.088987, 0.098880, 0.103510, 0.109678, 0.117833, 0.114652, 0.103520
#*# 	  0.110050, 0.102714, 0.094702, 0.085529, 0.078137, 0.071315, 0.067142, 0.059361, 0.050243, 0.045811, 0.037749, 0.029328, 0.017297, 0.010772, 0.009301, 0.002709, 0.006139, 0.013727, 0.026207, 0.039055, 0.055664, 0.071128, 0.086510, 0.102372, 0.116543, 0.123560, 0.126184, 0.128733, 0.124149, 0.118953
#*# 	  0.112782, 0.106050, 0.096822, 0.089356, 0.081742, 0.075272, 0.068554, 0.062313, 0.052699, 0.045126, 0.040019, 0.033671, 0.025042, 0.018668, 0.011520, 0.008031, 0.010334, 0.018403, 0.027237, 0.045290, 0.061346, 0.075583, 0.092304, 0.108486, 0.120523, 0.133045, 0.132413, 0.133371, 0.131238, 0.123917
#*# 	  0.109130, 0.101216, 0.093352, 0.083582, 0.075728, 0.069385, 0.062978, 0.055005, 0.046057, 0.038063, 0.031055, 0.026503, 0.020961, 0.010317, 0.003368, 0.000473, -0.001540, 0.008840, 0.018616, 0.035078, 0.048581, 0.063169, 0.081717, 0.095219, 0.106200, 0.113493, 0.119298, 0.127786, 0.126116, 0.116686
#*# 	  0.104367, 0.098223, 0.090227, 0.080623, 0.071915, 0.067383, 0.060942, 0.052176, 0.042209, 0.037579, 0.030377, 0.021799, 0.014669, 0.008500, 0.001943, -0.002889, -0.003866, 0.006912, 0.017439, 0.028329, 0.043892, 0.058374, 0.072100, 0.089176, 0.102436, 0.107372, 0.113580, 0.115508, 0.113055, 0.107718
#*# 	  0.102516, 0.094849, 0.087114, 0.076328, 0.070035, 0.065907, 0.056286, 0.049865, 0.041000, 0.034559, 0.030394, 0.022589, 0.013061, 0.001877, -0.004024, -0.000264, 0.000346, 0.001097, 0.011146, 0.018768, 0.035786, 0.055475, 0.067316, 0.081343, 0.092823, 0.101092, 0.112649, 0.105353, 0.104791, 0.104610
#*# 	  0.090547, 0.086073, 0.078936, 0.069583, 0.063863, 0.059660, 0.053877, 0.044315, 0.036763, 0.029416, 0.023012, 0.017416, 0.009477, 0.003224, -0.002269, -0.002541, -0.003347, 0.001274, 0.008879, 0.022175, 0.044014, 0.059677, 0.070182, 0.086391, 0.096737, 0.106253, 0.113271, 0.119585, 0.118568, 0.114408
#*# 	  0.088823, 0.081569, 0.074807, 0.064961, 0.056781, 0.054666, 0.047342, 0.038697, 0.029872, 0.023655, 0.014058, 0.009748, 0.001654, -0.004200, -0.004727, -0.009176, -0.017864, -0.012416, 0.001508, 0.020150, 0.035762, 0.046928, 0.061194, 0.075922, 0.088264, 0.094928, 0.103289, 0.109528, 0.108027, 0.109359
#*# 	  0.085593, 0.075913, 0.070464, 0.062244, 0.054254, 0.051140, 0.041571, 0.034059, 0.026181, 0.017763, 0.010875, 0.004400, -0.002832, -0.010692, -0.016582, -0.019560, -0.018585, -0.009934, -0.000223, 0.010848, 0.022215, 0.039055, 0.054328, 0.069494, 0.080874, 0.089250, 0.097824, 0.107053, 0.093653, 0.090866
#*# 	  0.085286, 0.076902, 0.068490, 0.059160, 0.052650, 0.047391, 0.040680, 0.031109, 0.020492, 0.015353, 0.008204, 0.001104, -0.002743, -0.013748, -0.022039, -0.029731, -0.030080, -0.013683, -0.009106, 0.005342, 0.020702, 0.033168, 0.046872, 0.056701, 0.073310, 0.082269, 0.089782, 0.095735, 0.100332, 0.089529
#*# 	  0.081904, 0.076237, 0.068251, 0.056436, 0.050420, 0.043802, 0.037776, 0.027073, 0.019019, 0.012317, 0.004777, -0.004489, -0.013299, -0.020060, -0.027402, -0.032850, -0.032213, -0.027804, -0.022318, -0.004123, 0.005845, 0.020354, 0.034643, 0.049903, 0.066373, 0.069296, 0.077343, 0.082570, 0.075198, 0.076327
#*# 	  0.079003, 0.073071, 0.063099, 0.052881, 0.044109, 0.038273, 0.032628, 0.021321, 0.013078, 0.008266, -0.000888, -0.014093, -0.020781, -0.027331, -0.036315, -0.036619, -0.040917, -0.036365, -0.029942, -0.019079, -0.000296, 0.010961, 0.024721, 0.038491, 0.053588, 0.064299, 0.073550, 0.071416, 0.063936, 0.061600
#*# 	  0.078054, 0.074270, 0.062118, 0.051975, 0.041576, 0.035975, 0.027959, 0.018279, 0.009720, 0.003159, -0.004343, -0.013643, -0.024260, -0.032995, -0.042399, -0.049929, -0.047903, -0.046371, -0.033222, -0.021500, -0.008899, 0.009895, 0.018641, 0.025179, 0.038711, 0.048662, 0.064530, 0.063599, 0.063059, 0.055887
#*# 	  0.076990, 0.068818, 0.061354, 0.050262, 0.040146, 0.032527, 0.022356, 0.015269, 0.006163, 0.001230, -0.006731, -0.018992, -0.028972, -0.038797, -0.047754, -0.059062, -0.057982, -0.049682, -0.039607, -0.027668, -0.013361, 0.001099, 0.015730, 0.031509, 0.036463, 0.040275, 0.053415, 0.057473, 0.057707, 0.054914
#*# 	  0.070659, 0.065719, 0.058361, 0.047748, 0.038795, 0.031954, 0.023509, 0.012825, 0.004479, -0.004300, -0.012695, -0.021161, -0.030562, -0.038440, -0.048782, -0.055109, -0.055106, -0.049806, -0.040102, -0.029049, -0.016335, 0.005838, 0.016839, 0.035182, 0.041701, 0.050243, 0.058939, 0.057307, 0.056321, 0.059684
#*# 	  0.069124, 0.062852, 0.053279, 0.043409, 0.035150, 0.028989, 0.020457, 0.008421, -0.003733, -0.010258, -0.019345, -0.029238, -0.039474, -0.047565, -0.060791, -0.062843, -0.061907, -0.056960, -0.049793, -0.037436, -0.025202, -0.009529, -0.002614, 0.015362, 0.031348, 0.036912, 0.044605, 0.055232, 0.055299, 0.048357
#*# 	  0.069942, 0.063273, 0.055533, 0.045420, 0.036803, 0.029712, 0.022142, 0.010043, 0.001062, -0.009095, -0.016839, -0.026784, -0.035811, -0.045452, -0.053197, -0.059393, -0.060684, -0.054817, -0.041819, -0.027311, -0.014456, -0.007862, 0.003826, 0.022203, 0.034636, 0.045012, 0.054045, 0.057961, 0.056636, 0.053316
#*# 	  0.072365, 0.064174, 0.056777, 0.045661, 0.036191, 0.029247, 0.021027, 0.011086, 0.000185, -0.010705, -0.021360, -0.029780, -0.043038, -0.052135, -0.057920, -0.064417, -0.062451, -0.058057, -0.049889, -0.040485, -0.025214, -0.014685, -0.000362, 0.016186, 0.027547, 0.035111, 0.043082, 0.049957, 0.050129, 0.048582
#*# 	  0.074869, 0.066105, 0.058512, 0.047965, 0.040656, 0.030308, 0.019670, 0.010137, 0.001060, -0.008207, -0.017396, -0.026039, -0.036309, -0.045315, -0.055395, -0.064043, -0.063971, -0.059241, -0.047880, -0.036599, -0.022022, -0.008907, 0.001770, 0.017023, 0.029157, 0.035862, 0.042519, 0.048843, 0.052324, 0.052827
#*# 	  0.067921, 0.060508, 0.047064, 0.039836, 0.033494, 0.024630, 0.014810, 0.005088, -0.005442, -0.012563, -0.019382, -0.029986, -0.043099, -0.051866, -0.061241, -0.070265, -0.070790, -0.063086, -0.054173, -0.039368, -0.027648, -0.014020, -0.003070, 0.011638, 0.025965, 0.030722, 0.034021, 0.041556, 0.048452, 0.050958
#*# 	  0.067400, 0.058848, 0.051921, 0.041032, 0.034484, 0.027293, 0.023181, 0.012560, 0.001909, -0.004563, -0.012625, -0.022141, -0.028131, -0.037040, -0.044962, -0.050530, -0.050747, -0.044782, -0.034967, -0.019856, -0.004947, 0.008345, 0.024523, 0.038998, 0.051671, 0.060213, 0.069982, 0.078298, 0.083522, 0.085400
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 12.0
#*# max_x = 213.0
#*# min_y = 13.0
#*# max_y = 203.0
